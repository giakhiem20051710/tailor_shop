<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security & JWT Audit Report - Tailor Shop</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a0000 0%, #2a1010 50%, #1a0000 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #ff4444;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        h2 {
            color: #ffd700;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
        }

        h3 {
            color: #00ff88;
            margin: 25px 0 15px;
        }

        h4 {
            color: #00d9ff;
            margin: 20px 0 10px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mermaid {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            color: #00ff88;
            font-family: 'Consolas', monospace;
        }

        pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 12px;
        }

        .critical {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(139, 0, 0, 0.2));
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #ff0000;
            margin: 15px 0;
        }

        .high {
            background: linear-gradient(135deg, rgba(255, 100, 0, 0.2), rgba(200, 50, 0, 0.2));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ff6600;
            margin: 15px 0;
        }

        .medium {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(200, 150, 0, 0.2));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }

        .low {
            background: linear-gradient(135deg, rgba(0, 200, 255, 0.1), rgba(0, 100, 200, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00d9ff;
            margin: 15px 0;
        }

        .good {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 200, 100, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
            margin: 15px 0;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 3px;
        }

        .badge-critical {
            background: #ff0000;
            color: white;
        }

        .badge-high {
            background: #ff6600;
            color: white;
        }

        .badge-medium {
            background: #ffc107;
            color: black;
        }

        .badge-low {
            background: #17a2b8;
            color: white;
        }

        .badge-good {
            background: #28a745;
            color: white;
        }

        .score-box {
            text-align: center;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin: 20px 0;
        }

        .score {
            font-size: 5em;
            font-weight: bold;
        }

        .score.fail {
            color: #ff4444;
        }

        .score.warn {
            color: #ffc107;
        }

        .score.pass {
            color: #00ff88;
        }

        ul,
        ol {
            padding-left: 25px;
            margin: 10px 0;
        }

        li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .file-path {
            color: #888;
            font-size: 12px;
        }

        .fix-code {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîí Security & JWT Audit Report</h1>
        <p class="subtitle">Tailor Shop Backend - Production Readiness Assessment</p>

        <!-- Score -->
        <div class="score-box">
            <div class="score warn">65/100</div>
            <p style="color: #ffc107; font-size: 1.5em; margin-top: 15px;">‚ö†Ô∏è C·∫¶N C·∫¢I THI·ªÜN</p>
            <p style="color: #888; margin-top: 10px;">Ph√°t hi·ªán 3 Critical + 3 High + 3 Medium issues</p>
        </div>

        <!-- Summary -->
        <div class="section">
            <h2>üìä T·ªïng Quan</h2>
            <table>
                <tr>
                    <th>Severity</th>
                    <th>Count</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><span class="badge badge-critical">CRITICAL</span></td>
                    <td>3</td>
                    <td>Secrets exposed, Actuator open, Production URLs thi·∫øu</td>
                </tr>
                <tr>
                    <td><span class="badge badge-high">HIGH</span></td>
                    <td>3</td>
                    <td>JWT token qu√° d√†i, thi·∫øu Refresh Token, Rate Limit b·ªã reset</td>
                </tr>
                <tr>
                    <td><span class="badge badge-medium">MEDIUM</span></td>
                    <td>3</td>
                    <td>Thi·∫øu token revocation, thi·∫øu HTTP headers, thi·∫øu audit log</td>
                </tr>
                <tr>
                    <td><span class="badge badge-good">GOOD</span></td>
                    <td>8</td>
                    <td>C√°c t√≠nh nƒÉng b·∫£o m·∫≠t ƒë√£ implement t·ªët</td>
                </tr>
            </table>
        </div>

        <!-- Architecture -->
        <div class="section">
            <h2>üèóÔ∏è Ki·∫øn Tr√∫c B·∫£o M·∫≠t Hi·ªán T·∫°i</h2>

            <div class="mermaid">
                flowchart TB
                subgraph "Client Request"
                REQ[HTTP Request]
                end

                subgraph "Spring Security Filter Chain"
                CORS[CORS Filter]
                JWT[JwtAuthFilter]
                AUTH[AuthenticationProvider]
                end

                subgraph "Services"
                AS[AuthService]
                JS[JwtService]
                LAS[LoginAttemptService]
                CUDS[CustomUserDetailsService]
                end

                subgraph "Data"
                UR[(UserRepository)]
                PRTR[(PasswordResetTokenRepo)]
                end

                REQ --> CORS
                CORS --> JWT
                JWT --> AUTH
                AUTH --> CUDS
                CUDS --> UR

                AS --> JS
                AS --> LAS
                AS --> PRTR
            </div>
        </div>

        <!-- CRITICAL Issues -->
        <div class="section">
            <h2>üö® CRITICAL Issues (Ph·∫£i fix ngay!)</h2>

            <div class="critical">
                <h3>1. ‚õî SECRETS EXPOSED IN CODE & .env TRONG GIT</h3>
                <p class="file-path">Files: .env, application.yml</p>

                <p><strong>V·∫•n ƒë·ªÅ:</strong> T·∫•t c·∫£ secrets (JWT, AWS, Email, Gemini API) ƒë·ªÅu ƒë∆∞·ª£c hardcode v√† c√≥ th·ªÉ ƒë√£
                    commit l√™n Git.</p>

                <pre><code># .env (EXPOSED!)
JWT_SECRET=your-jwt-secret-key-here
AWS_ACCESS_KEY=YOUR_AWS_ACCESS_KEY_HERE
AWS_SECRET_KEY=YOUR_AWS_SECRET_KEY_HERE
MAIL_PASSWORD=your_mail_password_here
GEMINI_API_KEY=your_gemini_api_key_here</code></pre>

                <div class="fix-code">
                    <strong>‚úÖ FIX:</strong>
                    <ol>
                        <li>Th√™m <code>.env</code> v√†o <code>.gitignore</code> NGAY</li>
                        <li>Revoke t·∫•t c·∫£ API keys hi·ªán t·∫°i v√† t·∫°o m·ªõi</li>
                        <li>S·ª≠ d·ª•ng Secret Manager (AWS Secrets Manager, HashiCorp Vault)</li>
                        <li>Ki·ªÉm tra git history v√† x√≥a secrets ƒë√£ commit: <code>git filter-branch</code></li>
                    </ol>
                </div>
            </div>

            <div class="critical">
                <h3>2. ‚õî ACTUATOR EXPOSED TO PUBLIC</h3>
                <p class="file-path">File: application.yml (line 98-99)</p>

                <p><strong>V·∫•n ƒë·ªÅ:</strong> T·∫•t c·∫£ actuator endpoints ƒë·ªÅu public, bao g·ªìm <code>/actuator/env</code>,
                    <code>/actuator/heapdump</code>, etc.
                </p>

                <pre><code>management:
  endpoints:
    web:
      exposure:
        include: "*"  # ‚ö†Ô∏è DANGEROUS!</code></pre>

                <div class="fix-code">
                    <strong>‚úÖ FIX:</strong>
                    <pre><code>management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus  # Ch·ªâ expose c·∫ßn thi·∫øt
  endpoint:
    health:
      show-details: when-authorized  # Kh√¥ng show cho anonymous</code></pre>
                </div>
            </div>

            <div class="critical">
                <h3>3. ‚õî CORS CH·ªà C√ì LOCALHOST - PRODUCTION S·∫º FAIL</h3>
                <p class="file-path">File: SecurityConfig.java (line 92-104)</p>

                <p><strong>V·∫•n ƒë·ªÅ:</strong> CORS ch·ªâ cho ph√©p localhost, khi deploy production s·∫Ω b·ªã block.</p>

                <pre><code>configuration.setAllowedOrigins(List.of(
    "http://localhost",
    "http://localhost:80",
    "http://localhost:3000",
    // ... ch·ªâ c√≥ localhost
));</code></pre>

                <div class="fix-code">
                    <strong>‚úÖ FIX:</strong> S·ª≠ d·ª•ng environment variable
                    <pre><code>@Value("${cors.allowed-origins}")
private List<String> allowedOrigins;

// application-prod.yml
cors:
  allowed-origins: https://tailor-shop.com,https://www.tailor-shop.com</code></pre>
                </div>
            </div>
        </div>

        <!-- HIGH Issues -->
        <div class="section">
            <h2>üî• HIGH Issues (C·∫ßn fix tr∆∞·ªõc production)</h2>

            <div class="high">
                <h3>4. JWT Token Expiration Qu√° D√†i</h3>
                <p class="file-path">File: application.yml (line 61)</p>

                <p><strong>V·∫•n ƒë·ªÅ:</strong> Token expires sau <strong>24 gi·ªù</strong> (86400000ms). N·∫øu token b·ªã steal,
                    attacker c√≥ 24h ƒë·ªÉ exploit.</p>

                <pre><code>jwt:
  expiration: 86400000  # 24 hours - TOO LONG!</code></pre>

                <div class="fix-code">
                    <strong>‚úÖ FIX:</strong>
                    <ul>
                        <li>Access Token: 15-30 ph√∫t (900000 - 1800000 ms)</li>
                        <li>Implement Refresh Token (7-14 ng√†y)</li>
                    </ul>
                </div>
            </div>

            <div class="high">
                <h3>5. Thi·∫øu Refresh Token Mechanism</h3>
                <p class="file-path">Impact: JwtService, AuthService</p>

                <p><strong>V·∫•n ƒë·ªÅ:</strong> Kh√¥ng c√≥ refresh token, user ph·∫£i login l·∫°i sau m·ªói 24h (ho·∫∑c ng·∫Øn h∆°n n·∫øu
                    fix issue #4).</p>

                <div class="fix-code">
                    <strong>‚úÖ FIX:</strong> Implement Refresh Token
                    <pre><code>public class RefreshTokenEntity {
    String token;        // UUID ho·∫∑c JWT
    Long userId;
    Instant expiresAt;   // 7-14 days
    boolean revoked;
}

// Endpoint: POST /api/v1/auth/refresh
public TokenResponse refreshToken(String refreshToken)</code></pre>
                </div>
            </div>

            <div class="high">
                <h3>6. LoginAttemptService B·ªã Reset Khi Restart</h3>
                <p class="file-path">File: LoginAttemptService.java</p>

                <p><strong>V·∫•n ƒë·ªÅ:</strong> Login attempts l∆∞u trong memory (ConcurrentHashMap), restart server = reset
                    count.</p>

                <pre><code>private final Map<String, Attempts> attempts = new ConcurrentHashMap<>();
// Restart server ‚Üí Map tr·ªëng ‚Üí Attacker c√≥ th·ªÉ brute force l·∫°i</code></pre>

                <div class="fix-code">
                    <strong>‚úÖ FIX:</strong> L∆∞u v√†o Redis ho·∫∑c Database
                    <pre><code>@Autowired
private RedisTemplate<String, Integer> redisTemplate;

public void recordFailure(String key) {
    String redisKey = "login:attempts:" + key;
    redisTemplate.opsForValue().increment(redisKey);
    redisTemplate.expire(redisKey, 15, TimeUnit.MINUTES);
}</code></pre>
                </div>
            </div>
        </div>

        <!-- MEDIUM Issues -->
        <div class="section">
            <h2>‚ö†Ô∏è MEDIUM Issues (N√™n fix)</h2>

            <div class="medium">
                <h3>7. Thi·∫øu Token Revocation / Blacklist</h3>
                <p><strong>V·∫•n ƒë·ªÅ:</strong> Kh√¥ng th·ªÉ invalidate token khi user logout ho·∫∑c b·ªã ban.</p>

                <div class="fix-code">
                    <strong>‚úÖ FIX:</strong> Implement token blacklist ho·∫∑c JTI (JWT ID)
                    <pre><code>// Redis blacklist
public void revokeToken(String token) {
    String jti = jwtService.extractJti(token);
    long ttl = jwtService.extractExpiration(token) - System.currentTimeMillis();
    redisTemplate.opsForValue().set("blacklist:" + jti, "1", ttl, MILLISECONDS);
}

public boolean isTokenBlacklisted(String token) {
    String jti = jwtService.extractJti(token);
    return redisTemplate.hasKey("blacklist:" + jti);
}</code></pre>
                </div>
            </div>

            <div class="medium">
                <h3>8. Thi·∫øu Security HTTP Headers</h3>
                <p><strong>V·∫•n ƒë·ªÅ:</strong> Kh√¥ng c√≥ headers b·∫£o m·∫≠t: X-Content-Type-Options, X-Frame-Options, CSP, HSTS
                </p>

                <div class="fix-code">
                    <strong>‚úÖ FIX:</strong> Th√™m v√†o SecurityConfig
                    <pre><code>http
    .headers(headers -> headers
        .contentTypeOptions(Customizer.withDefaults())
        .frameOptions(frame -> frame.deny())
        .xssProtection(xss -> xss.headerValue(XXssProtectionHeaderWriter.HeaderValue.ENABLED_MODE_BLOCK))
        .contentSecurityPolicy(csp -> csp.policyDirectives("default-src 'self'"))
        .httpStrictTransportSecurity(hsts -> hsts
            .includeSubDomains(true)
            .maxAgeInSeconds(31536000))
    )</code></pre>
                </div>
            </div>

            <div class="medium">
                <h3>9. Thi·∫øu Audit Log cho Security Events</h3>
                <p><strong>V·∫•n ƒë·ªÅ:</strong> Kh√¥ng log c√°c events: login success/failure, password change, role change
                </p>

                <div class="fix-code">
                    <strong>‚úÖ FIX:</strong> Th√™m audit logging
                    <pre><code>@Slf4j
public class SecurityAuditLogger {
    public void logLoginSuccess(String username, String ip) {
        log.info("AUDIT: LOGIN_SUCCESS user={} ip={}", username, ip);
    }
    public void logLoginFailure(String username, String ip, String reason) {
        log.warn("AUDIT: LOGIN_FAILURE user={} ip={} reason={}", username, ip, reason);
    }
}</code></pre>
                </div>
            </div>
        </div>

        <!-- GOOD Things -->
        <div class="section">
            <h2>‚úÖ Nh·ªØng ƒêi·ªÉm T·ªët</h2>

            <div class="good">
                <h3>ƒê√£ Implement ƒê√∫ng C√°ch:</h3>
                <ul>
                    <li>‚úÖ <strong>BCrypt Password Encoder</strong> - ƒê√∫ng chu·∫©n industry</li>
                    <li>‚úÖ <strong>JWT v·ªõi HMAC-SHA256</strong> - Y√™u c·∫ßu key >= 32 bytes</li>
                    <li>‚úÖ <strong>Stateless Session</strong> - SessionCreationPolicy.STATELESS</li>
                    <li>‚úÖ <strong>CSRF Disabled</strong> - Ph√π h·ª£p v·ªõi REST API + JWT</li>
                    <li>‚úÖ <strong>Login Attempt Limiting</strong> - 5 attempts / 15 ph√∫t</li>
                    <li>‚úÖ <strong>OTP for Password Reset</strong> - 6 digits, 10 ph√∫t expire</li>
                    <li>‚úÖ <strong>Rate Limit OTP</strong> - Max 3 requests / 30 ph√∫t</li>
                    <li>‚úÖ <strong>Role-based Authorization</strong> - @EnableMethodSecurity</li>
                    <li>‚úÖ <strong>Soft Delete Users</strong> - findByXxxAndIsDeletedFalse()</li>
                    <li>‚úÖ <strong>Role Validation on Register</strong> - Kh√¥ng cho ph√©p t·ª± ƒëƒÉng k√Ω admin</li>
                </ul>
            </div>
        </div>

        <!-- JWT Flow -->
        <div class="section">
            <h2>üîê JWT Authentication Flow (Hi·ªán t·∫°i)</h2>

            <div class="mermaid">
                sequenceDiagram
                participant C as Client
                participant F as JwtAuthFilter
                participant JS as JwtService
                participant UDS as UserDetailsService
                participant SC as SecurityContext

                C->>F: Request + Bearer token
                F->>F: Extract token from header
                F->>JS: extractUsername(token)
                JS-->>F: username

                F->>UDS: loadUserByUsername(username)
                UDS-->>F: UserDetails

                F->>JS: isTokenValid(token, userDetails)
                JS-->>F: true/false

                alt Token Valid
                F->>SC: setAuthentication(authToken)
                F->>C: Continue to Controller
                else Token Invalid
                F->>C: 401 Unauthorized
                end
            </div>
        </div>

        <!-- Action Plan -->
        <div class="section">
            <h2>üìã Priority Action Plan</h2>

            <table>
                <tr>
                    <th>Priority</th>
                    <th>Issue</th>
                    <th>Effort</th>
                    <th>Action</th>
                </tr>
                <tr>
                    <td><span class="badge badge-critical">P0</span></td>
                    <td>Secrets in Git</td>
                    <td>1h</td>
                    <td>Revoke keys, add .env to .gitignore, clean git history</td>
                </tr>
                <tr>
                    <td><span class="badge badge-critical">P0</span></td>
                    <td>Actuator exposed</td>
                    <td>15min</td>
                    <td>Limit exposed endpoints</td>
                </tr>
                <tr>
                    <td><span class="badge badge-critical">P0</span></td>
                    <td>CORS localhost only</td>
                    <td>30min</td>
                    <td>Add production domains via env var</td>
                </tr>
                <tr>
                    <td><span class="badge badge-high">P1</span></td>
                    <td>JWT 24h expiration</td>
                    <td>15min</td>
                    <td>Reduce to 15-30 minutes</td>
                </tr>
                <tr>
                    <td><span class="badge badge-high">P1</span></td>
                    <td>No Refresh Token</td>
                    <td>4h</td>
                    <td>Implement refresh token mechanism</td>
                </tr>
                <tr>
                    <td><span class="badge badge-high">P1</span></td>
                    <td>LoginAttempt in-memory</td>
                    <td>2h</td>
                    <td>Move to Redis</td>
                </tr>
                <tr>
                    <td><span class="badge badge-medium">P2</span></td>
                    <td>No token revocation</td>
                    <td>3h</td>
                    <td>Implement blacklist in Redis</td>
                </tr>
                <tr>
                    <td><span class="badge badge-medium">P2</span></td>
                    <td>Missing security headers</td>
                    <td>30min</td>
                    <td>Add to SecurityConfig</td>
                </tr>
                <tr>
                    <td><span class="badge badge-medium">P2</span></td>
                    <td>No audit logging</td>
                    <td>2h</td>
                    <td>Implement SecurityAuditLogger</td>
                </tr>
            </table>
        </div>

        <!-- Production Checklist -->
        <div class="section">
            <h2>‚úÖ Production Readiness Checklist</h2>

            <table>
                <tr>
                    <th>Item</th>
                    <th>Status</th>
                </tr>
                <tr>
                    <td>HTTPS enabled</td>
                    <td>‚ö†Ô∏è Check nginx/load balancer config</td>
                </tr>
                <tr>
                    <td>Secrets in Secret Manager</td>
                    <td>‚ùå Not implemented</td>
                </tr>
                <tr>
                    <td>JWT expiration reasonable</td>
                    <td>‚ùå 24h too long</td>
                </tr>
                <tr>
                    <td>Refresh token mechanism</td>
                    <td>‚ùå Not implemented</td>
                </tr>
                <tr>
                    <td>Brute force protection persisted</td>
                    <td>‚ùå In-memory only</td>
                </tr>
                <tr>
                    <td>Token revocation/logout</td>
                    <td>‚ùå Not implemented</td>
                </tr>
                <tr>
                    <td>Security headers</td>
                    <td>‚ùå Not configured</td>
                </tr>
                <tr>
                    <td>Audit logging</td>
                    <td>‚ùå Not implemented</td>
                </tr>
                <tr>
                    <td>Actuator secured</td>
                    <td>‚ùå All endpoints exposed</td>
                </tr>
                <tr>
                    <td>CORS for production</td>
                    <td>‚ùå Localhost only</td>
                </tr>
                <tr>
                    <td>Password encoding (BCrypt)</td>
                    <td>‚úÖ Implemented</td>
                </tr>
                <tr>
                    <td>Role-based access control</td>
                    <td>‚úÖ Implemented</td>
                </tr>
                <tr>
                    <td>OTP password reset</td>
                    <td>‚úÖ Implemented</td>
                </tr>
                <tr>
                    <td>Login attempt limiting</td>
                    <td>‚úÖ Implemented (in-memory)</td>
                </tr>
            </table>
        </div>

        <!-- Footer -->
        <div class="section" style="text-align: center; margin-top: 40px;">
            <p style="color: #888;">Generated by Antigravity AI Assistant</p>
            <p style="color: #666; font-size: 12px;">Security Audit Report - 2024</p>
            <a href="index.html" style="color: #00d9ff;">‚Üê Quay l·∫°i danh s√°ch</a>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
</body>

</html>