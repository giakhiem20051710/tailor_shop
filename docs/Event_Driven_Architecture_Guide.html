<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event-Driven Architecture - T√†i Li·ªáu & Interview Guide</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1a2d4a 50%, #0a1628 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.7;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #00d4ff;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        h2 {
            color: #ffd700;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
        }

        h3 {
            color: #00ff88;
            margin: 25px 0 15px;
        }

        h4 {
            color: #ff6b6b;
            margin: 20px 0 10px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mermaid {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            color: #00ff88;
            font-family: 'Consolas', monospace;
        }

        pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 13px;
        }

        .good {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 200, 100, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
            margin: 15px 0;
        }

        .bad {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.1), rgba(200, 0, 0, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ff4444;
            margin: 15px 0;
        }

        .info {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 150, 200, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00d4ff;
            margin: 15px 0;
        }

        .warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(200, 150, 0, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }

        .interview-q {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(100, 30, 180, 0.2));
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #9932cc;
            margin: 20px 0;
        }

        .answer {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .difficulty {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .easy {
            background: #28a745;
        }

        .medium {
            background: #ffc107;
            color: black;
        }

        .hard {
            background: #dc3545;
        }

        ul,
        ol {
            padding-left: 25px;
            margin: 10px 0;
        }

        li {
            margin: 8px 0;
        }

        .compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .compare {
                grid-template-columns: 1fr;
            }
        }

        .toc {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .toc a {
            color: #00d4ff;
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üöÄ Event-Driven Architecture</h1>
        <p class="subtitle">T√†i li·ªáu h·ªçc t·∫≠p & C√¢u h·ªèi ph·ªèng v·∫•n th∆∞·ªùng g·∫∑p</p>

        <!-- Table of Contents -->
        <div class="toc">
            <h3>üìë M·ª•c L·ª•c</h3>
            <ol>
                <li><a href="#what-is">Event-Driven Architecture l√† g√¨?</a></li>
                <li><a href="#why-use">T·∫°i sao s·ª≠ d·ª•ng Event-Driven?</a></li>
                <li><a href="#components">C√°c th√†nh ph·∫ßn ch√≠nh</a></li>
                <li><a href="#patterns">C√°c pattern ph·ªï bi·∫øn</a></li>
                <li><a href="#spring-impl">Implement v·ªõi Spring Boot</a></li>
                <li><a href="#pros-cons">∆Øu ƒëi·ªÉm v√† Nh∆∞·ª£c ƒëi·ªÉm</a></li>
                <li><a href="#real-world">·ª®ng d·ª•ng th·ª±c t·∫ø</a></li>
                <li><a href="#interview">C√¢u h·ªèi ph·ªèng v·∫•n (Q1-Q10)</a></li>
                <li><a href="#retry-dlq">üÜï Retry Logic & Dead-Letter Queue</a></li>
                <li><a href="#tailor-impl">üÜï Implementation trong Tailor Shop</a></li>
            </ol>
        </div>

        <!-- Section 1: What is EDA -->
        <div class="section" id="what-is">
            <h2>1Ô∏è‚É£ Event-Driven Architecture l√† g√¨?</h2>

            <div class="info">
                <strong>ƒê·ªãnh nghƒ©a:</strong> Event-Driven Architecture (EDA) l√† m·ªôt design pattern trong ƒë√≥ c√°c th√†nh
                ph·∫ßn c·ªßa h·ªá th·ªëng giao ti·∫øp v·ªõi nhau th√¥ng qua vi·ªác <strong>ph√°t sinh (produce)</strong> v√† <strong>l·∫Øng
                    nghe (consume)</strong> c√°c s·ª± ki·ªán (events).
            </div>

            <h3>üîë Kh√°i ni·ªám c·ªët l√µi</h3>

            <div class="mermaid">
                flowchart LR
                subgraph Producer["Producer (Ngu·ªìn ph√°t)"]
                A[Service A]
                end

                subgraph EventBus["Event Bus / Message Broker"]
                E[üì® Event]
                end

                subgraph Consumers["Consumers (Ng∆∞·ªùi nghe)"]
                B[Service B]
                C[Service C]
                D[Service D]
                end

                A -->|"publish"| E
                E -->|"subscribe"| B
                E -->|"subscribe"| C
                E -->|"subscribe"| D

                style A fill:#4CAF50,color:white
                style E fill:#FF9800,color:white
                style B fill:#2196F3,color:white
                style C fill:#2196F3,color:white
                style D fill:#2196F3,color:white
            </div>

            <h3>üìñ Thu·∫≠t ng·ªØ quan tr·ªçng</h3>
            <table>
                <tr>
                    <th>Thu·∫≠t ng·ªØ</th>
                    <th>ƒê·ªãnh nghƒ©a</th>
                    <th>V√≠ d·ª•</th>
                </tr>
                <tr>
                    <td><code>Event</code></td>
                    <td>M·ªôt s·ª± ki·ªán ƒë√£ x·∫£y ra trong h·ªá th·ªëng</td>
                    <td>OrderCreatedEvent, UserRegisteredEvent</td>
                </tr>
                <tr>
                    <td><code>Producer</code></td>
                    <td>Service ph√°t sinh event</td>
                    <td>OrderService publish OrderCreatedEvent</td>
                </tr>
                <tr>
                    <td><code>Consumer</code></td>
                    <td>Service l·∫Øng nghe v√† x·ª≠ l√Ω event</td>
                    <td>EmailService listen OrderCreatedEvent</td>
                </tr>
                <tr>
                    <td><code>Event Bus</code></td>
                    <td>K√™nh truy·ªÅn t·∫£i event</td>
                    <td>ApplicationEventPublisher, Kafka, RabbitMQ</td>
                </tr>
                <tr>
                    <td><code>Event Handler</code></td>
                    <td>Logic x·ª≠ l√Ω event</td>
                    <td>@EventListener method</td>
                </tr>
            </table>
        </div>

        <!-- Section 2: Why use EDA -->
        <div class="section" id="why-use">
            <h2>2Ô∏è‚É£ T·∫°i sao s·ª≠ d·ª•ng Event-Driven?</h2>

            <h3>‚ùå V·∫•n ƒë·ªÅ v·ªõi Synchronous (ƒê·ªìng b·ªô)</h3>

            <div class="bad">
                <h4>V√≠ d·ª•: T·∫°o ƒë∆°n h√†ng ƒë·ªìng b·ªô</h4>
                <pre><code>public OrderResponse createOrder(OrderRequest request) {
    Order order = saveOrder(request);           // ‚è±Ô∏è 50ms
    invoiceService.createInvoice(order);        // ‚è±Ô∏è 100ms (ch·ªù)
    appointmentService.createAppointment(order); // ‚è±Ô∏è 80ms (ch·ªù)
    emailService.sendConfirmation(order);       // ‚è±Ô∏è 2000ms (ch·ªù SMTP!)
    smsService.sendNotification(order);         // ‚è±Ô∏è 1500ms (ch·ªù API)
    
    return toResponse(order);
    // T·ªîNG TH·ªúI GIAN: 3730ms = 3.7 gi√¢y!
}</code></pre>
            </div>

            <div class="mermaid">
                sequenceDiagram
                participant U as User
                participant O as OrderService
                participant I as InvoiceService
                participant E as EmailService
                participant S as SMSService

                U->>O: createOrder()
                O->>O: saveOrder (50ms)
                O->>I: createInvoice (100ms)
                I-->>O: done
                O->>E: sendEmail (2000ms)
                E-->>O: done
                O->>S: sendSMS (1500ms)
                S-->>O: done
                O-->>U: response (3650ms total!)

                Note over U,S: User ph·∫£i CH·ªú 3.7 gi√¢y!
            </div>

            <h3>‚úÖ Gi·∫£i ph√°p v·ªõi Event-Driven</h3>

            <div class="good">
                <h4>V√≠ d·ª•: T·∫°o ƒë∆°n h√†ng Event-Driven</h4>
                <pre><code>public OrderResponse createOrder(OrderRequest request) {
    Order order = saveOrder(request);           // ‚è±Ô∏è 50ms
    
    // Publish event v√† RETURN NGAY
    eventPublisher.publishEvent(new OrderCreatedEvent(order));
    
    return toResponse(order);
    // T·ªîNG TH·ªúI GIAN: ~100ms!
}

// C√°c listeners ch·∫°y ASYNC (background)
@Async @EventListener
public void onOrderCreated(OrderCreatedEvent event) {
    emailService.sendConfirmation(event.getOrder());
}</code></pre>
            </div>

            <div class="mermaid">
                sequenceDiagram
                participant U as User
                participant O as OrderService
                participant EB as Event Bus
                participant I as InvoiceListener
                participant E as EmailListener
                participant S as SMSListener

                U->>O: createOrder()
                O->>O: saveOrder (50ms)
                O->>EB: publish(OrderCreatedEvent)
                O-->>U: response (100ms total!)

                Note over U: User nh·∫≠n response NGAY!

                par Background Processing
                EB->>I: OrderCreatedEvent
                I->>I: createInvoice (async)
                and
                EB->>E: OrderCreatedEvent
                E->>E: sendEmail (async)
                and
                EB->>S: OrderCreatedEvent
                S->>S: sendSMS (async)
                end
            </div>

            <h3>üìä So s√°nh hi·ªáu nƒÉng</h3>
            <table>
                <tr>
                    <th>Ti√™u ch√≠</th>
                    <th>‚ùå Synchronous</th>
                    <th>‚úÖ Event-Driven</th>
                </tr>
                <tr>
                    <td>Response time</td>
                    <td>3730ms</td>
                    <td>~100ms</td>
                </tr>
                <tr>
                    <td>User experience</td>
                    <td>Ch·ªù l√¢u üò§</td>
                    <td>Ph·∫£n h·ªìi nhanh üòä</td>
                </tr>
                <tr>
                    <td>1 service fail</td>
                    <td>C·∫£ request fail</td>
                    <td>C√°c service kh√°c v·∫´n ch·∫°y</td>
                </tr>
                <tr>
                    <td>Th√™m feature m·ªõi</td>
                    <td>S·ª≠a OrderService</td>
                    <td>Th√™m 1 Listener m·ªõi</td>
                </tr>
                <tr>
                    <td>Coupling</td>
                    <td>Cao (bi·∫øt t·∫•t c·∫£)</td>
                    <td>Th·∫•p (ch·ªâ bi·∫øt Event)</td>
                </tr>
            </table>
        </div>

        <!-- Section 3: Components -->
        <div class="section" id="components">
            <h2>3Ô∏è‚É£ C√°c th√†nh ph·∫ßn ch√≠nh</h2>

            <div class="mermaid">
                flowchart TB
                subgraph EventComponents["Event-Driven Components"]
                subgraph Event["1. Event Class"]
                E1["OrderCreatedEvent<br />- orderId<br />- customerId<br />- timestamp"]
                end

                subgraph Publisher["2. Event Publisher"]
                P1["ApplicationEventPublisher<br />eventPublisher.publishEvent()"]
                end

                subgraph Listeners["3. Event Listeners"]
                L1["InvoiceListener<br />@EventListener"]
                L2["EmailListener<br />@Async @EventListener"]
                L3["AnalyticsListener<br />@TransactionalEventListener"]
                end

                subgraph Broker["4. Message Broker (Optional)"]
                B1["Kafka / RabbitMQ<br />For distributed systems"]
                end
                end

                E1 --> P1
                P1 --> L1
                P1 --> L2
                P1 --> L3
                P1 -.-> B1
            </div>

            <h3>üîπ 1. Event Class</h3>
            <pre><code>public class OrderCreatedEvent {
    private final Long orderId;
    private final Long customerId;
    private final BigDecimal totalAmount;
    private final LocalDateTime createdAt;
    
    public OrderCreatedEvent(Order order) {
        this.orderId = order.getId();
        this.customerId = order.getCustomerId();
        this.totalAmount = order.getTotal();
        this.createdAt = LocalDateTime.now();
    }
    // getters
}</code></pre>

            <h3>üîπ 2. Event Publisher</h3>
            <pre><code>@Service
public class OrderService {
    private final ApplicationEventPublisher eventPublisher;
    
    public void createOrder(OrderRequest request) {
        Order order = orderRepository.save(toEntity(request));
        
        // Publish event
        eventPublisher.publishEvent(new OrderCreatedEvent(order));
    }
}</code></pre>

            <h3>üîπ 3. Event Listeners</h3>
            <pre><code>@Component
public class OrderEventListeners {
    
    // Sync listener (c√πng thread, c√πng transaction)
    @EventListener
    public void handleSync(OrderCreatedEvent event) {
        log.info("Sync: Order {} created", event.getOrderId());
    }
    
    // Async listener (thread ri√™ng, kh√¥ng block)
    @Async
    @EventListener
    public void handleAsync(OrderCreatedEvent event) {
        emailService.sendConfirmation(event);
    }
    
    // Ch·∫°y SAU KHI transaction commit th√†nh c√¥ng
    @TransactionalEventListener(phase = AFTER_COMMIT)
    public void handleAfterCommit(OrderCreatedEvent event) {
        notificationService.notify(event);
    }
}</code></pre>
        </div>

        <!-- Section 4: Patterns -->
        <div class="section" id="patterns">
            <h2>4Ô∏è‚É£ C√°c Pattern ph·ªï bi·∫øn</h2>

            <h3>Pattern 1: Event Notification</h3>
            <div class="info">
                <strong>M·ª•c ƒë√≠ch:</strong> Th√¥ng b√°o r·∫±ng m·ªôt s·ª± ki·ªán ƒë√£ x·∫£y ra. Consumer t·ª± quy·∫øt ƒë·ªãnh x·ª≠ l√Ω th·∫ø n√†o.
            </div>
            <pre><code>// Event ch·ªâ ch·ª©a ID, consumer t·ª± fetch data n·∫øu c·∫ßn
public class OrderCreatedEvent {
    private final Long orderId;  // Ch·ªâ ID
}</code></pre>

            <h3>Pattern 2: Event-Carried State Transfer</h3>
            <div class="info">
                <strong>M·ª•c ƒë√≠ch:</strong> Event mang theo ƒë·∫ßy ƒë·ªß data, consumer kh√¥ng c·∫ßn g·ªçi l·∫°i producer.
            </div>
            <pre><code>// Event mang ƒë·∫ßy ƒë·ªß data
public class OrderCreatedEvent {
    private final Long orderId;
    private final String customerName;
    private final String customerEmail;
    private final List<OrderItem> items;
    private final BigDecimal total;
    // Kh√¥ng c·∫ßn fetch l·∫°i!
}</code></pre>

            <h3>Pattern 3: Event Sourcing</h3>
            <div class="info">
                <strong>M·ª•c ƒë√≠ch:</strong> L∆∞u T·∫§T C·∫¢ events thay v√¨ l∆∞u state hi·ªán t·∫°i. C√≥ th·ªÉ replay ƒë·ªÉ rebuild state.
            </div>
            <div class="mermaid">
                flowchart LR
                subgraph Events["Event Store"]
                E1["OrderCreated"]
                E2["ItemAdded"]
                E3["PaymentReceived"]
                E4["OrderShipped"]
                end

                subgraph State["Current State (computed)"]
                S["Order Status: SHIPPED<br />Total: 500k<br />Items: 3"]
                end

                E1 --> E2 --> E3 --> E4 --> S
            </div>

            <h3>Pattern 4: CQRS (Command Query Responsibility Segregation)</h3>
            <div class="info">
                <strong>M·ª•c ƒë√≠ch:</strong> T√°ch bi·ªát Write (Command) v√† Read (Query) models.
            </div>
            <div class="mermaid">
                flowchart TB
                subgraph Commands["Write Side"]
                C1["CreateOrder"]
                C2["UpdateOrder"]
                WD[(Write DB)]
                end

                subgraph Events["Event Bus"]
                EV["Events"]
                end

                subgraph Queries["Read Side"]
                Q1["GetOrderList"]
                Q2["GetOrderDetails"]
                RD[(Read DB - Optimized)]
                end

                C1 --> WD
                C2 --> WD
                WD --> EV
                EV --> RD
                RD --> Q1
                RD --> Q2
            </div>
        </div>

        <!-- Section 5: Spring Implementation -->
        <div class="section" id="spring-impl">
            <h2>5Ô∏è‚É£ Implement v·ªõi Spring Boot</h2>

            <h3>Step 1: T·∫°o Event Class</h3>
            <pre><code>// events/OrderCreatedEvent.java
public class OrderCreatedEvent {
    private final Order order;
    private final LocalDateTime timestamp;
    
    public OrderCreatedEvent(Order order) {
        this.order = order;
        this.timestamp = LocalDateTime.now();
    }
    
    public Order getOrder() { return order; }
    public LocalDateTime getTimestamp() { return timestamp; }
}</code></pre>

            <h3>Step 2: Publish Event t·ª´ Service</h3>
            <pre><code>@Service
@RequiredArgsConstructor
public class OrderServiceImpl implements OrderService {
    private final OrderRepository orderRepository;
    private final ApplicationEventPublisher eventPublisher;
    
    @Transactional
    public OrderResponse createOrder(OrderRequest request) {
        // 1. Business logic
        Order order = new Order();
        order.setCustomerId(request.getCustomerId());
        order.setStatus(OrderStatus.PENDING);
        order = orderRepository.save(order);
        
        // 2. Publish event
        eventPublisher.publishEvent(new OrderCreatedEvent(order));
        
        return toResponse(order);
    }
}</code></pre>

            <h3>Step 3: T·∫°o Event Listeners</h3>
            <pre><code>@Component
@RequiredArgsConstructor
@Slf4j
public class OrderEventListeners {
    private final InvoiceService invoiceService;
    private final EmailService emailService;
    
    @Async
    @EventListener
    public void createInvoice(OrderCreatedEvent event) {
        log.info("Creating invoice for order {}", event.getOrder().getId());
        invoiceService.createForOrder(event.getOrder());
    }
    
    @Async
    @EventListener
    public void sendConfirmationEmail(OrderCreatedEvent event) {
        log.info("Sending confirmation for order {}", event.getOrder().getId());
        emailService.sendOrderConfirmation(event.getOrder());
    }
    
    // Ch·∫°y SAU KHI transaction commit
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void notifyAnalytics(OrderCreatedEvent event) {
        log.info("Tracking order {} in analytics", event.getOrder().getId());
        // analytics tracking...
    }
}</code></pre>

            <h3>Step 4: Enable Async</h3>
            <pre><code>@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(500);
        executor.setThreadNamePrefix("EventListener-");
        executor.initialize();
        return executor;
    }
}</code></pre>
        </div>

        <!-- Section 6: Pros and Cons -->
        <div class="section" id="pros-cons">
            <h2>6Ô∏è‚É£ ∆Øu ƒëi·ªÉm v√† Nh∆∞·ª£c ƒëi·ªÉm</h2>

            <div class="compare">
                <div class="good">
                    <h3>‚úÖ ∆Øu ƒëi·ªÉm</h3>
                    <ul>
                        <li><strong>Loose Coupling</strong>: Services kh√¥ng ph·ª• thu·ªôc tr·ª±c ti·∫øp</li>
                        <li><strong>Scalability</strong>: D·ªÖ scale t·ª´ng service ri√™ng</li>
                        <li><strong>Flexibility</strong>: Th√™m/x√≥a features kh√¥ng ·∫£nh h∆∞·ªüng code c≈©</li>
                        <li><strong>Performance</strong>: Async processing, response nhanh</li>
                        <li><strong>Fault Tolerance</strong>: 1 listener fail kh√¥ng ·∫£nh h∆∞·ªüng listeners kh√°c</li>
                        <li><strong>Auditability</strong>: Events c√≥ th·ªÉ l∆∞u l√†m audit log</li>
                    </ul>
                </div>

                <div class="bad">
                    <h3>‚ùå Nh∆∞·ª£c ƒëi·ªÉm</h3>
                    <ul>
                        <li><strong>Complexity</strong>: Debug kh√≥ h∆°n (distributed tracing)</li>
                        <li><strong>Eventual Consistency</strong>: Data kh√¥ng nh·∫•t qu√°n ngay l·∫≠p t·ª©c</li>
                        <li><strong>Event Ordering</strong>: Kh√¥ng ƒë·∫£m b·∫£o th·ª© t·ª± events</li>
                        <li><strong>Error Handling</strong>: Retry, dead-letter queue ph·ª©c t·∫°p</li>
                        <li><strong>Testing</strong>: Integration testing ph·ª©c t·∫°p h∆°n</li>
                        <li><strong>Monitoring</strong>: C·∫ßn tools chuy√™n d·ª•ng (Zipkin, Jaeger)</li>
                    </ul>
                </div>
            </div>

            <h3>‚ö†Ô∏è Khi n√†o KH√îNG n√™n d√πng Event-Driven?</h3>
            <div class="warning">
                <ul>
                    <li>Khi c·∫ßn <strong>response ƒë·ªìng b·ªô</strong> ngay l·∫≠p t·ª©c (VD: check stock tr∆∞·ªõc khi order)</li>
                    <li>Khi <strong>th·ª© t·ª± x·ª≠ l√Ω</strong> r·∫•t quan tr·ªçng</li>
                    <li>Khi h·ªá th·ªëng <strong>nh·ªè, ƒë∆°n gi·∫£n</strong> (over-engineering)</li>
                    <li>Khi c·∫ßn <strong>strong consistency</strong> (VD: banking transactions)</li>
                </ul>
            </div>
        </div>

        <!-- Section 7: Real World -->
        <div class="section" id="real-world">
            <h2>7Ô∏è‚É£ ·ª®ng d·ª•ng th·ª±c t·∫ø</h2>

            <h3>üè¢ C√°c c√¥ng ty l·ªõn s·ª≠ d·ª•ng EDA</h3>
            <table>
                <tr>
                    <th>C√¥ng ty</th>
                    <th>Use Case</th>
                    <th>Technology</th>
                </tr>
                <tr>
                    <td>Netflix</td>
                    <td>User activity tracking, recommendations</td>
                    <td>Apache Kafka</td>
                </tr>
                <tr>
                    <td>Uber</td>
                    <td>Trip events, driver matching</td>
                    <td>Apache Kafka</td>
                </tr>
                <tr>
                    <td>LinkedIn</td>
                    <td>Activity feed, notifications</td>
                    <td>Apache Kafka</td>
                </tr>
                <tr>
                    <td>Shopee</td>
                    <td>Order processing, inventory</td>
                    <td>Kafka + RabbitMQ</td>
                </tr>
                <tr>
                    <td>Grab</td>
                    <td>Real-time tracking, payments</td>
                    <td>Kafka</td>
                </tr>
            </table>

            <h3>üì¶ Message Brokers ph·ªï bi·∫øn</h3>
            <table>
                <tr>
                    <th>Broker</th>
                    <th>Best for</th>
                    <th>ƒê·∫∑c ƒëi·ªÉm</th>
                </tr>
                <tr>
                    <td>Spring Events</td>
                    <td>Single app, simple cases</td>
                    <td>Built-in, easy, no infra</td>
                </tr>
                <tr>
                    <td>RabbitMQ</td>
                    <td>Task queues, microservices</td>
                    <td>Flexible routing, reliable</td>
                </tr>
                <tr>
                    <td>Apache Kafka</td>
                    <td>High throughput, event streaming</td>
                    <td>Scalable, persistent, replay</td>
                </tr>
                <tr>
                    <td>AWS SQS/SNS</td>
                    <td>AWS ecosystem</td>
                    <td>Managed, serverless</td>
                </tr>
                <tr>
                    <td>Redis Pub/Sub</td>
                    <td>Real-time, simple pub/sub</td>
                    <td>Fast, in-memory</td>
                </tr>
            </table>
        </div>

        <!-- Section 8: Interview Questions -->
        <div class="section" id="interview">
            <h2>8Ô∏è‚É£ C√¢u h·ªèi ph·ªèng v·∫•n th∆∞·ªùng g·∫∑p</h2>

            <!-- Question 1 -->
            <div class="interview-q">
                <h4>Q1: Event-Driven Architecture l√† g√¨? <span class="difficulty easy">Easy</span></h4>
                <div class="answer">
                    <strong>Tr·∫£ l·ªùi:</strong><br>
                    Event-Driven Architecture l√† m·ªôt design pattern trong ƒë√≥ c√°c components giao ti·∫øp th√¥ng qua vi·ªác
                    publish v√† subscribe c√°c events. Thay v√¨ g·ªçi tr·ª±c ti·∫øp, service A publish m·ªôt event khi c√≥ s·ª± ki·ªán
                    x·∫£y ra, v√† c√°c services kh√°c subscribe ƒë·ªÉ l·∫Øng nghe v√† x·ª≠ l√Ω event ƒë√≥ m·ªôt c√°ch ƒë·ªôc l·∫≠p.
                    <br><br>
                    <strong>V√≠ d·ª•:</strong> Khi OrderService t·∫°o ƒë∆°n h√†ng, n√≥ publish OrderCreatedEvent. EmailService,
                    InvoiceService, InventoryService l·∫Øng nghe event n√†y v√† x·ª≠ l√Ω async m√† kh√¥ng c·∫ßn OrderService bi·∫øt
                    v·ªÅ s·ª± t·ªìn t·∫°i c·ªßa h·ªç.
                </div>
            </div>

            <!-- Question 2 -->
            <div class="interview-q">
                <h4>Q2: Ph√¢n bi·ªát Synchronous vs Event-Driven? <span class="difficulty easy">Easy</span></h4>
                <div class="answer">
                    <table>
                        <tr>
                            <th>Ti√™u ch√≠</th>
                            <th>Synchronous</th>
                            <th>Event-Driven</th>
                        </tr>
                        <tr>
                            <td>Coupling</td>
                            <td>Tight - caller bi·∫øt callee</td>
                            <td>Loose - ch·ªâ bi·∫øt event</td>
                        </tr>
                        <tr>
                            <td>Response</td>
                            <td>Ch·ªù t·∫•t c·∫£ xong</td>
                            <td>Return ngay</td>
                        </tr>
                        <tr>
                            <td>Failure</td>
                            <td>1 fail = all fail</td>
                            <td>Isolated failures</td>
                        </tr>
                        <tr>
                            <td>Scale</td>
                            <td>Kh√≥ scale ri√™ng</td>
                            <td>D·ªÖ scale t·ª´ng listener</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Question 3 -->
            <div class="interview-q">
                <h4>Q3: @EventListener vs @TransactionalEventListener kh√°c nhau th·∫ø n√†o? <span
                        class="difficulty medium">Medium</span></h4>
                <div class="answer">
                    <ul>
                        <li><code>@EventListener</code>: Ch·∫°y NGAY khi event ƒë∆∞·ª£c publish, trong c√πng transaction.</li>
                        <li><code>@TransactionalEventListener</code>: Ch·∫°y SAU KHI transaction k·∫øt th√∫c.</li>
                    </ul>
                    <pre><code>// Ch·∫°y ngay, n·∫øu exception ‚Üí rollback c·∫£ transaction
@EventListener
public void handleSync(OrderCreatedEvent e) { }

// Ch·∫°y SAU COMMIT, ƒë·∫£m b·∫£o order ƒë√£ l∆∞u th√†nh c√¥ng
@TransactionalEventListener(phase = AFTER_COMMIT)
public void handleAfterCommit(OrderCreatedEvent e) { }

// Ch·∫°y khi transaction ROLLBACK
@TransactionalEventListener(phase = AFTER_ROLLBACK)
public void handleRollback(OrderCreatedEvent e) { }</code></pre>
                </div>
            </div>

            <!-- Question 4 -->
            <div class="interview-q">
                <h4>Q4: Eventual Consistency l√† g√¨? L√†m sao x·ª≠ l√Ω? <span class="difficulty medium">Medium</span></h4>
                <div class="answer">
                    <strong>ƒê·ªãnh nghƒ©a:</strong> Trong EDA, data gi·ªØa c√°c services c√≥ th·ªÉ kh√¥ng ƒë·ªìng b·ªô ngay l·∫≠p t·ª©c,
                    nh∆∞ng s·∫Ω nh·∫•t qu√°n SAU M·ªòT KHO·∫¢NG TH·ªúI GIAN.
                    <br><br>
                    <strong>V√≠ d·ª•:</strong> Sau khi t·∫°o order, inventory c√≥ th·ªÉ m·∫•t v√†i gi√¢y ƒë·ªÉ c·∫≠p nh·∫≠t. Trong th·ªùi
                    gian ƒë√≥, stock hi·ªÉn th·ªã c√≥ th·ªÉ ch∆∞a ch√≠nh x√°c.
                    <br><br>
                    <strong>C√°ch x·ª≠ l√Ω:</strong>
                    <ul>
                        <li>UI hi·ªÉn th·ªã tr·∫°ng th√°i "Processing..." thay v√¨ d·ªØ li·ªáu c≈©</li>
                        <li>Optimistic UI: c·∫≠p nh·∫≠t UI tr∆∞·ªõc, sync sau</li>
                        <li>Compensating transactions: rollback n·∫øu downstream fail</li>
                        <li>Idempotent consumers: x·ª≠ l√Ω duplicate events an to√†n</li>
                    </ul>
                </div>
            </div>

            <!-- Question 5 -->
            <div class="interview-q">
                <h4>Q5: L√†m sao ƒë·∫£m b·∫£o event ƒë∆∞·ª£c x·ª≠ l√Ω ƒë√∫ng 1 l·∫ßn (Exactly-Once)? <span
                        class="difficulty hard">Hard</span></h4>
                <div class="answer">
                    <strong>V·∫•n ƒë·ªÅ:</strong> Network issues c√≥ th·ªÉ g√¢y duplicate events ho·∫∑c lost events.
                    <br><br>
                    <strong>3 delivery semantics:</strong>
                    <ul>
                        <li><strong>At-most-once</strong>: C√≥ th·ªÉ m·∫•t event (fire and forget)</li>
                        <li><strong>At-least-once</strong>: Event c√≥ th·ªÉ x·ª≠ l√Ω nhi·ªÅu l·∫ßn (retry on failure)</li>
                        <li><strong>Exactly-once</strong>: M·ªói event x·ª≠ l√Ω ƒë√∫ng 1 l·∫ßn (kh√≥ nh·∫•t)</li>
                    </ul>
                    <br>
                    <strong>C√°ch ƒë·∫°t Exactly-Once:</strong>
                    <pre><code>// 1. Idempotent Consumer: check n·∫øu ƒë√£ x·ª≠ l√Ω
@EventListener
public void handle(OrderCreatedEvent e) {
    if (processedEventRepository.exists(e.getEventId())) {
        return; // Skip duplicate
    }
    // Process...
    processedEventRepository.save(e.getEventId());
}

// 2. Outbox Pattern: l∆∞u event v√†o DB c√πng transaction
@Transactional
public void createOrder() {
    orderRepo.save(order);
    outboxRepo.save(new OutboxEvent(orderCreatedEvent));
    // Scheduler picks up and publishes
}</code></pre>
                </div>
            </div>

            <!-- Question 6 -->
            <div class="interview-q">
                <h4>Q6: Event Sourcing l√† g√¨? Kh√°c g√¨ CRUD th√¥ng th∆∞·ªùng? <span class="difficulty hard">Hard</span></h4>
                <div class="answer">
                    <strong>CRUD th√¥ng th∆∞·ªùng:</strong> L∆∞u STATE hi·ªán t·∫°i c·ªßa entity.
                    <pre><code>// Ch·ªâ bi·∫øt state hi·ªán t·∫°i
Order { id: 1, status: SHIPPED, total: 500k }</code></pre>

                    <strong>Event Sourcing:</strong> L∆∞u T·∫§T C·∫¢ events ƒë√£ x·∫£y ra, rebuild state t·ª´ events.
                    <pre><code>// C√≥ full history
OrderCreated { orderId: 1, total: 500k }
ItemAdded { orderId: 1, item: "Shirt" }
PaymentReceived { orderId: 1, amount: 500k }
OrderShipped { orderId: 1, trackingNo: "VN123" }

// State = replay t·∫•t c·∫£ events</code></pre>

                    <strong>∆Øu ƒëi·ªÉm Event Sourcing:</strong>
                    <ul>
                        <li>Full audit trail</li>
                        <li>Time travel (xem state t·∫°i b·∫•t k·ª≥ th·ªùi ƒëi·ªÉm)</li>
                        <li>Debug production issues d·ªÖ h∆°n</li>
                        <li>Rebuild read models kh√°c nhau t·ª´ c√πng events</li>
                    </ul>
                </div>
            </div>

            <!-- Question 7 -->
            <div class="interview-q">
                <h4>Q7: Saga Pattern l√† g√¨? D√πng khi n√†o? <span class="difficulty hard">Hard</span></h4>
                <div class="answer">
                    <strong>ƒê·ªãnh nghƒ©a:</strong> Saga l√† pattern qu·∫£n l√Ω distributed transactions qua nhi·ªÅu services
                    b·∫±ng c√°ch s·ª≠ d·ª•ng sequence of local transactions + compensating transactions.
                    <br><br>
                    <strong>V√≠ d·ª• Order Saga:</strong>
                    <div class="mermaid">
                        sequenceDiagram
                        participant O as OrderService
                        participant I as InventoryService
                        participant P as PaymentService
                        participant S as ShippingService

                        O->>I: ReserveStock
                        I-->>O: StockReserved
                        O->>P: ProcessPayment
                        P-->>O: PaymentFailed ‚ùå
                        O->>I: CompensateStock (rollback)
                        I-->>O: StockReleased
                        O->>O: OrderFailed
                    </div>

                    <strong>2 lo·∫°i Saga:</strong>
                    <ul>
                        <li><strong>Choreography</strong>: M·ªói service l·∫Øng nghe events v√† quy·∫øt ƒë·ªãnh b∆∞·ªõc ti·∫øp</li>
                        <li><strong>Orchestration</strong>: C√≥ 1 Saga Orchestrator ƒëi·ªÅu ph·ªëi t·∫•t c·∫£ steps</li>
                    </ul>
                </div>
            </div>

            <!-- Question 8 -->
            <div class="interview-q">
                <h4>Q8: So s√°nh Kafka vs RabbitMQ? <span class="difficulty medium">Medium</span></h4>
                <div class="answer">
                    <table>
                        <tr>
                            <th>Ti√™u ch√≠</th>
                            <th>Kafka</th>
                            <th>RabbitMQ</th>
                        </tr>
                        <tr>
                            <td>Architecture</td>
                            <td>Distributed log</td>
                            <td>Message broker</td>
                        </tr>
                        <tr>
                            <td>Throughput</td>
                            <td>R·∫•t cao (millions/sec)</td>
                            <td>Cao (tens of thousands)</td>
                        </tr>
                        <tr>
                            <td>Message retention</td>
                            <td>Configurable (days/weeks)</td>
                            <td>Deleted after consumed</td>
                        </tr>
                        <tr>
                            <td>Consumer model</td>
                            <td>Pull-based</td>
                            <td>Push-based</td>
                        </tr>
                        <tr>
                            <td>Replay</td>
                            <td>C√≥ th·ªÉ replay messages</td>
                            <td>Kh√¥ng th·ªÉ</td>
                        </tr>
                        <tr>
                            <td>Ordering</td>
                            <td>Per partition</td>
                            <td>Per queue</td>
                        </tr>
                        <tr>
                            <td>Best for</td>
                            <td>Event streaming, big data</td>
                            <td>Task queues, RPC</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Question 9 -->
            <div class="interview-q">
                <h4>Q9: L√†m sao debug Event-Driven system? <span class="difficulty medium">Medium</span></h4>
                <div class="answer">
                    <strong>Challenges:</strong> Events async, distributed, kh√¥ng c√≥ call stack r√µ r√†ng.
                    <br><br>
                    <strong>Solutions:</strong>
                    <ul>
                        <li><strong>Correlation ID</strong>: M·ªói request c√≥ 1 ID duy nh·∫•t, truy·ªÅn qua t·∫•t c·∫£ events</li>
                        <li><strong>Distributed Tracing</strong>: Zipkin, Jaeger, AWS X-Ray</li>
                        <li><strong>Centralized Logging</strong>: ELK Stack (Elasticsearch, Logstash, Kibana)</li>
                        <li><strong>Event Store</strong>: L∆∞u t·∫•t c·∫£ events ƒë·ªÉ replay v√† debug</li>
                    </ul>
                    <pre><code>// Correlation ID trong m·ªói event
public class OrderCreatedEvent {
    private String correlationId;  // TraceID
    private Long orderId;
    // ...
}

// Log v·ªõi correlation ID
log.info("[{}] Order created: {}", correlationId, orderId);</code></pre>
                </div>
            </div>

            <!-- Question 10 -->
            <div class="interview-q">
                <h4>Q10: Trong project c·ªßa b·∫°n, b·∫°n s·∫Ω √°p d·ª•ng EDA ·ªü ƒë√¢u? <span class="difficulty medium">Medium</span>
                </h4>
                <div class="answer">
                    <strong>V√≠ d·ª• v·ªõi Tailor Shop:</strong>
                    <ul>
                        <li><strong>OrderCreatedEvent</strong>: Trigger t·∫°o invoice, appointment, g·ª≠i email, reserve
                            fabric</li>
                        <li><strong>OrderStatusChangedEvent</strong>: Notify customer qua email/SMS</li>
                        <li><strong>FlashSalePurchaseEvent</strong>: Update stock, send confirmation, track analytics
                        </li>
                        <li><strong>UserRegisteredEvent</strong>: Send welcome email, create first-time discount</li>
                        <li><strong>FabricLowStockEvent</strong>: Alert admin, trigger auto-reorder</li>
                    </ul>
                    <br>
                    <strong>L·ª£i √≠ch c·ª• th·ªÉ:</strong>
                    <ul>
                        <li>Response time gi·∫£m t·ª´ 3-4 gi√¢y xu·ªëng ~100ms</li>
                        <li>Th√™m notification channel m·ªõi (Zalo, Telegram) kh√¥ng s·ª≠a OrderService</li>
                        <li>Email service down kh√¥ng ·∫£nh h∆∞·ªüng t·∫°o order</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section 9: Retry Logic & Dead-Letter Queue (NEW!) -->
        <div class="section" id="retry-dlq">
            <h2>9Ô∏è‚É£ Retry Logic & Dead-Letter Queue (DLQ)</h2>

            <div class="info">
                <strong>V·∫•n ƒë·ªÅ:</strong> Event listeners c√≥ th·ªÉ fail do network issues, service unavailable, database
                timeout...
                N·∫øu kh√¥ng c√≥ retry mechanism, event s·∫Ω b·ªã m·∫•t!
            </div>

            <h3>üîÑ Retry Pattern v·ªõi Exponential Backoff</h3>

            <div class="mermaid">
                flowchart LR
                subgraph Attempt["Retry Attempts"]
                A1["Attempt 1<br />Delay: 0ms"]
                A2["Attempt 2<br />Delay: 100ms"]
                A3["Attempt 3<br />Delay: 500ms"]
                A4["Attempt 4<br />Delay: 2000ms"]
                end

                subgraph Result["Result"]
                S["‚úÖ Success"]
                DLQ["üì• Dead-Letter Queue"]
                end

                A1 -->|fail| A2
                A2 -->|fail| A3
                A3 -->|fail| A4
                A4 -->|fail| DLQ
                A1 -->|success| S
                A2 -->|success| S
                A3 -->|success| S
                A4 -->|success| S

                style S fill:#4CAF50,color:white
                style DLQ fill:#f44336,color:white
            </div>

            <h3>üì• Dead-Letter Queue l√† g√¨?</h3>
            <div class="info">
                <strong>ƒê·ªãnh nghƒ©a:</strong> DLQ l√† n∆°i l∆∞u tr·ªØ c√°c events ƒë√£ fail sau max retries.
                Events trong DLQ c√≥ th·ªÉ ƒë∆∞·ª£c retry th·ªß c√¥ng ho·∫∑c analyze ƒë·ªÉ fix bugs.
            </div>

            <h3>üèóÔ∏è Implementation trong Tailor Shop</h3>

            <h4>1. @RetryableEvent Annotation</h4>
            <pre><code>@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RetryableEvent {
    int maxRetries() default 3;      // S·ªë l·∫ßn retry t·ªëi ƒëa
    boolean saveToDlq() default true; // L∆∞u v√†o DLQ khi fail
    Class<? extends Exception>[] retryOn() default { Exception.class };
    Class<? extends Exception>[] noRetryOn() default {};
}</code></pre>

            <h4>2. S·ª≠ d·ª•ng @RetryableEvent</h4>
            <pre><code>@Component
public class OrderEventListener {

    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Async("eventExecutor")
    @RetryableEvent(maxRetries = 3, saveToDlq = true)
    public void handleOrderCreated(OrderCreatedEvent event) {
        // N·∫øu throw exception:
        // 1. Retry 3 l·∫ßn v·ªõi exponential backoff
        // 2. N·∫øu v·∫´n fail -> Save to DLQ
        invoiceService.createForOrder(event.getOrderId());
    }
    
    // Critical operation - more retries
    @RetryableEvent(maxRetries = 5, saveToDlq = true)
    public void handleOrderCancelled(OrderCancelledEvent event) {
        inventoryService.releaseReservation(event.getOrderId());
        refundService.processRefund(event);
    }
}</code></pre>

            <h4>3. DLQ Entity (Database Table)</h4>
            <pre><code>@Entity
@Table(name = "failed_events")
public class FailedEventEntity {
    @Id
    private Long id;
    
    private String correlationId;    // Tracking ID
    private String eventType;        // "OrderCreatedEvent"
    private String eventPayload;     // JSON serialized event
    private String handlerClass;     // "OrderEventListener"
    private String handlerMethod;    // "handleOrderCreated"
    private String errorMessage;     // Exception message
    private String stackTrace;       // Full stack trace
    private Integer retryCount;      // Current retry count
    private Integer maxRetries;      // Max allowed retries
    
    @Enumerated
    private FailedEventStatus status; // PENDING, RETRYING, DEAD, PROCESSED
    
    private LocalDateTime nextRetryAt; // Scheduled retry time
    private LocalDateTime createdAt;
    private LocalDateTime processedAt;
}</code></pre>

            <h4>4. Exponential Backoff Schedule</h4>
            <table>
                <tr>
                    <th>Retry #</th>
                    <th>Delay</th>
                    <th>T·ªïng ch·ªù</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>1 ph√∫t</td>
                    <td>1 ph√∫t</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>5 ph√∫t</td>
                    <td>6 ph√∫t</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>15 ph√∫t</td>
                    <td>21 ph√∫t</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>30 ph√∫t</td>
                    <td>51 ph√∫t</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>60 ph√∫t</td>
                    <td>~2 gi·ªù</td>
                </tr>
                <tr>
                    <td>6+</td>
                    <td>120 ph√∫t</td>
                    <td>...</td>
                </tr>
            </table>

            <h4>5. Admin API cho DLQ Management</h4>
            <table>
                <tr>
                    <th>Endpoint</th>
                    <th>Method</th>
                    <th>M√¥ t·∫£</th>
                </tr>
                <tr>
                    <td><code>/api/v1/admin/dlq/stats</code></td>
                    <td>GET</td>
                    <td>Th·ªëng k√™ DLQ (pending, dead, processed)</td>
                </tr>
                <tr>
                    <td><code>/api/v1/admin/dlq/dead</code></td>
                    <td>GET</td>
                    <td>Danh s√°ch events c·∫ßn x·ª≠ l√Ω th·ªß c√¥ng</td>
                </tr>
                <tr>
                    <td><code>/api/v1/admin/dlq/{id}/retry</code></td>
                    <td>POST</td>
                    <td>Retry th·ªß c√¥ng m·ªôt event</td>
                </tr>
                <tr>
                    <td><code>/api/v1/admin/dlq/{id}/skip</code></td>
                    <td>POST</td>
                    <td>B·ªè qua event (ƒë√°nh d·∫•u ƒë√£ x·ª≠ l√Ω)</td>
                </tr>
            </table>

            <h3>üîß AOP Aspect x·ª≠ l√Ω Retry</h3>
            <pre><code>@Aspect
@Component
public class RetryableEventAspect {
    
    @Around("@annotation(retryableEvent)")
    public Object handleRetry(ProceedingJoinPoint joinPoint, 
                              RetryableEvent retryableEvent) throws Throwable {
        int maxRetries = retryableEvent.maxRetries();
        int attempt = 0;
        Exception lastException = null;
        
        while (attempt <= maxRetries) {
            try {
                return joinPoint.proceed();
            } catch (Exception e) {
                lastException = e;
                attempt++;
                
                if (attempt <= maxRetries) {
                    long delay = calculateBackoff(attempt);
                    Thread.sleep(delay);
                }
            }
        }
        
        // All retries failed - save to DLQ
        if (retryableEvent.saveToDlq()) {
            eventRetryService.saveFailedEvent(event, handler, lastException);
        }
        return null;
    }
    
    private long calculateBackoff(int attempt) {
        // Exponential: 100ms, 200ms, 400ms, 800ms... max 5000ms
        long delay = (long) (100 * Math.pow(2, attempt - 1));
        return Math.min(delay, 5000);
    }
}</code></pre>

            <h3>‚è∞ Scheduled Retry Job</h3>
            <pre><code>@Service
public class EventRetryService {

    @Scheduled(fixedDelay = 60000) // Every 1 minute
    @Transactional
    public void processRetryQueue() {
        List<FailedEventEntity> events = 
            failedEventRepository.findEventsReadyForRetry(LocalDateTime.now());
        
        for (FailedEventEntity event : events) {
            try {
                retryEvent(event);
                event.markProcessed();
            } catch (Exception e) {
                event.scheduleNextRetry(); // Exponential backoff
                if (event.getStatus() == DEAD) {
                    // Alert admin - manual intervention needed
                    alertService.sendDlqAlert(event);
                }
            }
            failedEventRepository.save(event);
        }
    }
    
    @Scheduled(cron = "0 0 3 * * *") // 3 AM daily
    public void cleanupOldEvents() {
        // Delete processed events older than 7 days
        failedEventRepository.deleteProcessedEventsBefore(
            LocalDateTime.now().minusDays(7)
        );
    }
}</code></pre>
        </div>

        <!-- Section 10: Tailor Shop Implementation -->
        <div class="section" id="tailor-impl">
            <h2>üîü Implementation trong Tailor Shop</h2>

            <h3>üìÅ C·∫•u tr√∫c th∆∞ m·ª•c</h3>
            <pre><code>modules/
‚îú‚îÄ‚îÄ order/
‚îÇ   ‚îú‚îÄ‚îÄ event/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderCreatedEvent.java
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OrderStatusChangedEvent.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OrderCancelledEvent.java
‚îÇ   ‚îî‚îÄ‚îÄ listener/
‚îÇ       ‚îî‚îÄ‚îÄ OrderEventListener.java
‚îú‚îÄ‚îÄ flashsale/
‚îÇ   ‚îú‚îÄ‚îÄ event/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FlashSalePurchaseEvent.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ReservationExpiredEvent.java
‚îÇ   ‚îî‚îÄ‚îÄ listener/
‚îÇ       ‚îî‚îÄ‚îÄ FlashSaleEventListener.java
‚îú‚îÄ‚îÄ notification/
‚îÇ   ‚îî‚îÄ‚îÄ listener/
‚îÇ       ‚îî‚îÄ‚îÄ NotificationEventListener.java
‚îú‚îÄ‚îÄ event/  (Core module)
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FailedEventEntity.java
‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FailedEventRepository.java
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EventRetryService.java
‚îÇ   ‚îú‚îÄ‚îÄ annotation/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ @RetryableEvent.java
‚îÇ   ‚îú‚îÄ‚îÄ aspect/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RetryableEventAspect.java
‚îÇ   ‚îî‚îÄ‚îÄ controller/
‚îÇ       ‚îî‚îÄ‚îÄ DlqAdminController.java
‚îî‚îÄ‚îÄ config/
    ‚îî‚îÄ‚îÄ AsyncEventConfig.java</code></pre>

            <h3>üîë Key Events trong Tailor Shop</h3>
            <table>
                <tr>
                    <th>Event</th>
                    <th>Trigger</th>
                    <th>Listeners</th>
                </tr>
                <tr>
                    <td><code>OrderCreatedEvent</code></td>
                    <td>T·∫°o order m·ªõi</td>
                    <td>Invoice, Appointment, Email, SMS</td>
                </tr>
                <tr>
                    <td><code>OrderStatusChangedEvent</code></td>
                    <td>ƒê·ªïi status order</td>
                    <td>Email, SMS, Dashboard</td>
                </tr>
                <tr>
                    <td><code>OrderCancelledEvent</code></td>
                    <td>H·ªßy order</td>
                    <td>Inventory, Refund, Email</td>
                </tr>
                <tr>
                    <td><code>FlashSalePurchaseEvent</code></td>
                    <td>Mua flash sale</td>
                    <td>Email, Analytics</td>
                </tr>
                <tr>
                    <td><code>ReservationExpiredEvent</code></td>
                    <td>H·∫øt h·∫°n reservation</td>
                    <td>Inventory, Email</td>
                </tr>
            </table>

            <h3>üìä Event Flow Diagram</h3>
            <div class="mermaid">
                flowchart TB
                subgraph OrderService["OrderService"]
                O1["createOrder()"]
                end

                subgraph EventPublisher["Event Publisher"]
                EP["publishEvent(OrderCreatedEvent)"]
                end

                subgraph EventBus["Spring Event Bus"]
                EB["OrderCreatedEvent"]
                end

                subgraph Listeners["Event Listeners (@Async)"]
                L1["OrderEventListener<br />‚Üí Create Invoice"]
                L2["OrderEventListener<br />‚Üí Create Appointment"]
                L3["NotificationEventListener<br />‚Üí Send Email"]
                L4["NotificationEventListener<br />‚Üí Send SMS"]
                end

                subgraph DLQ["Dead-Letter Queue"]
                D1["FailedEventEntity"]
                D2["Scheduled Retry"]
                D3["Admin Dashboard"]
                end

                O1 --> EP --> EB
                EB --> L1
                EB --> L2
                EB --> L3
                EB --> L4

                L1 -.->|"@RetryableEvent"| D1
                L2 -.->|"on failure"| D1
                L3 -.->|"after max retries"| D1

                D1 --> D2
                D1 --> D3

                style O1 fill:#4CAF50,color:white
                style EB fill:#FF9800,color:white
                style D1 fill:#f44336,color:white
            </div>
        </div>

        <!-- Additional Interview Questions about Retry/DLQ -->
        <div class="section">
            <h2>üìù Interview Questions b·ªï sung (Retry & DLQ)</h2>

            <div class="interview-q">
                <h4>Q11: Exponential Backoff l√† g√¨? T·∫°i sao d√πng? <span class="difficulty medium">Medium</span></h4>
                <div class="answer">
                    <strong>ƒê·ªãnh nghƒ©a:</strong> Exponential Backoff l√† chi·∫øn l∆∞·ª£c retry trong ƒë√≥ delay tƒÉng theo c·∫•p s·ªë
                    nh√¢n sau m·ªói l·∫ßn fail.
                    <br><br>
                    <strong>V√≠ d·ª•:</strong> 100ms ‚Üí 200ms ‚Üí 400ms ‚Üí 800ms ‚Üí 1600ms...
                    <br><br>
                    <strong>T·∫°i sao d√πng:</strong>
                    <ul>
                        <li>Tr√°nh "thundering herd" - nhi·ªÅu requests retry c√πng l√∫c l√†m overwhelm service</li>
                        <li>Cho service time to recover</li>
                        <li>Gi·∫£m load l√™n failing service</li>
                        <li>Th∆∞·ªùng k·∫øt h·ª£p v·ªõi jitter (random delay) ƒë·ªÉ tr√°nh synchronized retries</li>
                    </ul>
                    <pre><code>long delay = (long) (baseDelay * Math.pow(2, attempt));
double jitter = 0.8 + Math.random() * 0.4; // ¬±20%
delay = (long) (delay * jitter);</code></pre>
                </div>
            </div>

            <div class="interview-q">
                <h4>Q12: Dead-Letter Queue (DLQ) l√† g√¨? D√πng khi n√†o? <span class="difficulty medium">Medium</span></h4>
                <div class="answer">
                    <strong>ƒê·ªãnh nghƒ©a:</strong> DLQ l√† queue/storage l∆∞u tr·ªØ c√°c messages/events kh√¥ng th·ªÉ x·ª≠ l√Ω sau
                    nhi·ªÅu l·∫ßn retry.
                    <br><br>
                    <strong>D√πng khi:</strong>
                    <ul>
                        <li>Event processing fail sau max retries</li>
                        <li>Message format invalid (poison message)</li>
                        <li>Business logic error kh√¥ng th·ªÉ auto-recover</li>
                    </ul>
                    <br>
                    <strong>X·ª≠ l√Ω DLQ:</strong>
                    <ul>
                        <li>Monitor v√† alert khi c√≥ events trong DLQ</li>
                        <li>Analyze ƒë·ªÉ t√¨m root cause</li>
                        <li>Fix bug v√† replay events</li>
                        <li>Manual intervention cho edge cases</li>
                    </ul>
                </div>
            </div>

            <div class="interview-q">
                <h4>Q13: @TransactionalEventListener vs @EventListener? <span class="difficulty medium">Medium</span>
                </h4>
                <div class="answer">
                    <table>
                        <tr>
                            <th>Aspect</th>
                            <th>@EventListener</th>
                            <th>@TransactionalEventListener</th>
                        </tr>
                        <tr>
                            <td>Timing</td>
                            <td>Ngay khi publish</td>
                            <td>Sau transaction phase</td>
                        </tr>
                        <tr>
                            <td>Transaction</td>
                            <td>C√πng transaction</td>
                            <td>C√≥ th·ªÉ AFTER_COMMIT, AFTER_ROLLBACK</td>
                        </tr>
                        <tr>
                            <td>Rollback</td>
                            <td>Exception ‚Üí rollback c·∫£ transaction</td>
                            <td>Exception kh√¥ng ·∫£nh h∆∞·ªüng transaction g·ªëc</td>
                        </tr>
                        <tr>
                            <td>Use case</td>
                            <td>Validation, sync processing</td>
                            <td>Notifications, external calls</td>
                        </tr>
                    </table>
                    <pre><code>// Ch·∫°y NGAY, n·∫øu throw ‚Üí rollback order!
@EventListener
public void validate(OrderCreatedEvent e) { }

// Ch·∫°y SAU COMMIT, order ƒë√£ ƒë∆∞·ª£c l∆∞u ch·∫Øc ch·∫Øn
@TransactionalEventListener(phase = AFTER_COMMIT)
public void sendEmail(OrderCreatedEvent e) { }</code></pre>
                </div>
            </div>

            <div class="interview-q">
                <h4>Q14: L√†m sao handle Idempotency trong event processing? <span class="difficulty hard">Hard</span>
                </h4>
                <div class="answer">
                    <strong>V·∫•n ƒë·ªÅ:</strong> Do retry, m·ªôt event c√≥ th·ªÉ ƒë∆∞·ª£c x·ª≠ l√Ω NHI·ªÄU L·∫¶N. Ph·∫£i ƒë·∫£m b·∫£o x·ª≠ l√Ω N l·∫ßn =
                    x·ª≠ l√Ω 1 l·∫ßn.
                    <br><br>
                    <strong>Solutions:</strong>
                    <pre><code>// 1. Track processed events
@EventListener
public void handle(OrderCreatedEvent e) {
    String eventId = e.getCorrelationId();
    if (processedEventCache.contains(eventId)) {
        return; // Already processed
    }
    // Process...
    processedEventCache.add(eventId);
}

// 2. Database unique constraint
@Transactional
public void createInvoice(Long orderId) {
    if (invoiceRepository.existsByOrderId(orderId)) {
        return; // Already exists
    }
    invoiceRepository.save(new Invoice(orderId));
}

// 3. Optimistic locking
@Version
private Long version;</code></pre>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="section" style="text-align: center; margin-top: 40px;">
            <p style="color: #888;">Created for Tailor Shop Project</p>
            <p style="color: #666; font-size: 12px;">Event-Driven Architecture Guide - 2024 | Updated with Retry & DLQ
            </p>
            <a href="index.html" style="color: #00d4ff;">‚Üê Quay l·∫°i danh s√°ch</a>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
</body>

</html>