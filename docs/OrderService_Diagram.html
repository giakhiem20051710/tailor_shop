<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrderService - T√†i Li·ªáu Chi Ti·∫øt</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        h2 {
            color: #ffd700;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
        }

        h3 {
            color: #00ff88;
            margin: 25px 0 15px;
        }

        h4 {
            color: #ff6b9d;
            margin: 20px 0 10px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mermaid {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            color: #00ff88;
            font-family: 'Consolas', monospace;
        }

        pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        pre code {
            padding: 0;
            background: transparent;
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 107, 157, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ff6b6b;
            margin: 15px 0;
        }

        .success-box {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 217, 255, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
            margin: 15px 0;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }

        .info-box {
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 217, 255, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
        }

        ul,
        ol {
            padding-left: 25px;
            margin: 10px 0;
        }

        li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }

        .badge-primary {
            background: #007bff;
            color: white;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: black;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        .flow-step {
            display: inline-block;
            background: rgba(0, 217, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
        }

        .arrow {
            color: #ffd700;
            margin: 0 10px;
        }

        .toc {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .toc a {
            color: #00d9ff;
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 10px;
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-label {
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üì¶ OrderService - T√†i Li·ªáu Chi Ti·∫øt</h1>
        <p class="subtitle">Module qu·∫£n l√Ω ƒë∆°n h√†ng may ƒëo - Core Business Service</p>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">868</div>
                <div class="stat-label">D√≤ng code</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">10</div>
                <div class="stat-label">Methods ch√≠nh</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">11</div>
                <div class="stat-label">Dependencies</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">6</div>
                <div class="stat-label">Entities li√™n quan</div>
            </div>
        </div>

        <!-- TOC -->
        <div class="toc">
            <h3>üìë M·ª•c L·ª•c</h3>
            <ol>
                <li><a href="#overview">T·ªïng Quan</a></li>
                <li><a href="#architecture">Ki·∫øn Tr√∫c & Dependencies</a></li>
                <li><a href="#entities">Entity Relationships</a></li>
                <li><a href="#order-status">Order Status Flow</a></li>
                <li><a href="#methods">Chi Ti·∫øt Methods</a></li>
                <li><a href="#create-flow">Lu·ªìng T·∫°o ƒê∆°n H√†ng</a></li>
                <li><a href="#wizard-flow">Lu·ªìng T·∫°o Wizard</a></li>
                <li><a href="#auto-invoice">T·ª± ƒê·ªông T·∫°o H√≥a ƒê∆°n</a></li>
                <li><a href="#error-handling">X·ª≠ L√Ω L·ªói</a></li>
            </ol>
        </div>

        <!-- 1. Overview -->
        <div class="section" id="overview">
            <h2>1. T·ªïng Quan</h2>
            <p><code>OrderServiceImpl</code> l√† service ch√≠nh qu·∫£n l√Ω to√†n b·ªô lifecycle c·ªßa ƒë∆°n h√†ng may ƒëo trong h·ªá
                th·ªëng Tailor Shop.</p>

            <div class="success-box">
                <strong>‚úÖ Ch·ª©c nƒÉng ch√≠nh:</strong>
                <ul>
                    <li>T·∫°o ƒë∆°n h√†ng (th·ªß c√¥ng v√† wizard)</li>
                    <li>Qu·∫£n l√Ω tr·∫°ng th√°i ƒë∆°n h√†ng (Status Transition)</li>
                    <li>L∆∞u s·ªë ƒëo kh√°ch h√†ng (Measurements)</li>
                    <li>Upload attachments l√™n S3</li>
                    <li>T·ª± ƒë·ªông t·∫°o h√≥a ƒë∆°n (Invoice)</li>
                    <li>T·ª± ƒë·ªông t·∫°o l·ªãch h·∫πn (Appointment)</li>
                </ul>
            </div>

            <div class="info-box">
                <strong>üìç ƒê∆∞·ªùng d·∫´n file:</strong><br>
                <code>modules/order/service/impl/OrderServiceImpl.java</code>
            </div>
        </div>

        <!-- 2. Architecture -->
        <div class="section" id="architecture">
            <h2>2. Ki·∫øn Tr√∫c & Dependencies</h2>

            <div class="mermaid">
                graph TB
                subgraph "Controllers"
                OC[OrderController]
                end

                subgraph "OrderServiceImpl"
                OS[OrderServiceImpl]
                OS --> LIST[list - T√¨m ki·∫øm ƒë∆°n h√†ng]
                OS --> DETAIL[detail - Chi ti·∫øt ƒë∆°n h√†ng]
                OS --> CREATE[create - T·∫°o th·ªß c√¥ng]
                OS --> WIZARD[createWizard - T·∫°o wizard]
                OS --> STATUS[updateStatus - C·∫≠p nh·∫≠t tr·∫°ng th√°i]
                OS --> TRACKING[tracking - Theo d√µi]
                OS --> UPLOAD[uploadAttachment - Upload file]
                OS --> UPDATE[update - C·∫≠p nh·∫≠t]
                end

                subgraph "Repositories"
                OR[OrderRepository]
                OIR[OrderItemRepository]
                OTR[OrderTimelineRepository]
                OPR[OrderPaymentRepository]
                OAR[OrderAttachmentRepository]
                MR[MeasurementRepository]
                UR[UserRepository]
                IR[InvoiceRepository]
                end

                subgraph "External Services"
                S3[S3StorageService]
                AS[AppointmentService]
                IS[InvoiceService]
                end

                subgraph "Database"
                DB[(MySQL)]
                end

                OC --> OS
                LIST --> OR
                DETAIL --> OR
                CREATE --> OR
                CREATE --> OIR
                CREATE --> S3
                CREATE --> MR
                CREATE --> IS
                WIZARD --> AS
                STATUS --> OTR
                UPLOAD --> S3
                OR --> DB
            </div>

            <h3>Dependencies Injection</h3>
            <table>
                <tr>
                    <th>#</th>
                    <th>Dependency</th>
                    <th>M·ª•c ƒë√≠ch</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td><code>OrderRepository</code></td>
                    <td>CRUD ƒë∆°n h√†ng</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td><code>OrderItemRepository</code></td>
                    <td>Qu·∫£n l√Ω items trong ƒë∆°n</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td><code>OrderTimelineRepository</code></td>
                    <td>L·ªãch s·ª≠ tr·∫°ng th√°i</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td><code>OrderPaymentRepository</code></td>
                    <td>Thanh to√°n</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td><code>OrderAttachmentRepository</code></td>
                    <td>Files ƒë√≠nh k√®m</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td><code>UserRepository</code></td>
                    <td>Th√¥ng tin kh√°ch h√†ng, th·ª£ may</td>
                </tr>
                <tr>
                    <td>7</td>
                    <td><code>MeasurementRepository</code></td>
                    <td>S·ªë ƒëo</td>
                </tr>
                <tr>
                    <td>8</td>
                    <td><code>S3StorageService</code></td>
                    <td>Upload ·∫£nh l√™n AWS S3</td>
                </tr>
                <tr>
                    <td>9</td>
                    <td><code>AppointmentService</code></td>
                    <td>T·∫°o l·ªãch h·∫πn t·ª± ƒë·ªông</td>
                </tr>
                <tr>
                    <td>10</td>
                    <td><code>InvoiceService</code></td>
                    <td>T·∫°o h√≥a ƒë∆°n t·ª± ƒë·ªông</td>
                </tr>
                <tr>
                    <td>11</td>
                    <td><code>InvoiceRepository</code></td>
                    <td>Truy v·∫•n h√≥a ƒë∆°n</td>
                </tr>
            </table>
        </div>

        <!-- 3. Entities -->
        <div class="section" id="entities">
            <h2>3. Entity Relationships</h2>

            <div class="mermaid">
                erDiagram
                OrderEntity ||--o{ OrderItemEntity : "has many"
                OrderEntity ||--o{ OrderTimelineEntity : "has many"
                OrderEntity ||--o{ OrderPaymentEntity : "has many"
                OrderEntity ||--o{ OrderAttachmentEntity : "has many"
                OrderEntity ||--o{ MeasurementEntity : "has many"
                OrderEntity ||--o| InvoiceEntity : "has one"
                OrderEntity }o--|| UserEntity : "customer"
                OrderEntity }o--o| UserEntity : "tailor"

                OrderEntity {
                Long id PK
                String code UK
                OrderStatus status
                BigDecimal total
                BigDecimal depositAmount
                BigDecimal expectedBudget
                LocalDate appointmentDate
                LocalDate dueDate
                String note
                Long customerId FK
                Long tailorId FK
                }

                OrderItemEntity {
                Long id PK
                Long orderId FK
                Long productId FK
                Long fabricId FK
                Integer quantity
                BigDecimal unitPrice
                BigDecimal subtotal
                String productName
                }

                OrderTimelineEntity {
                Long id PK
                Long orderId FK
                OrderStatus status
                String note
                Instant createdAt
                Long createdById FK
                }
            </div>
        </div>

        <!-- 4. Order Status -->
        <div class="section" id="order-status">
            <h2>4. Order Status Flow (State Machine)</h2>

            <div class="mermaid">
                stateDiagram-v2
                [*] --> DRAFT : T·∫°o m·ªõi
                [*] --> WAITING_FOR_QUOTE : T·∫°o t·ª´ Wizard

                DRAFT --> WAITING_FOR_QUOTE : G·ª≠i b√°o gi√°
                DRAFT --> CANCELLED : H·ªßy

                WAITING_FOR_QUOTE --> CONFIRMED : Kh√°ch x√°c nh·∫≠n
                WAITING_FOR_QUOTE --> CANCELLED : H·ªßy

                CONFIRMED --> IN_PROGRESS : B·∫Øt ƒë·∫ßu may
                CONFIRMED --> CANCELLED : H·ªßy

                IN_PROGRESS --> FITTING : Th·ª≠ ƒë·ªì
                IN_PROGRESS --> CANCELLED : H·ªßy

                FITTING --> COMPLETED : Ho√†n th√†nh
                FITTING --> IN_PROGRESS : C·∫ßn ch·ªânh s·ª≠a
                FITTING --> CANCELLED : H·ªßy

                COMPLETED --> [*]
                CANCELLED --> [*]
            </div>

            <h3>Status Transition Rules</h3>
            <div class="highlight-box">
                <strong>‚ö†Ô∏è Quan tr·ªçng:</strong> Kh√¥ng ph·∫£i m·ªçi chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i ƒë·ªÅu ƒë∆∞·ª£c ph√©p.
                H·ªá th·ªëng s·ª≠ d·ª•ng <code>isTransitionAllowed()</code> ƒë·ªÉ validate.
            </div>

            <table>
                <tr>
                    <th>From Status</th>
                    <th>Allowed Transitions</th>
                </tr>
                <tr>
                    <td><span class="badge badge-info">DRAFT</span></td>
                    <td>WAITING_FOR_QUOTE, CANCELLED</td>
                </tr>
                <tr>
                    <td><span class="badge badge-warning">WAITING_FOR_QUOTE</span></td>
                    <td>CONFIRMED, CANCELLED</td>
                </tr>
                <tr>
                    <td><span class="badge badge-primary">CONFIRMED</span></td>
                    <td>IN_PROGRESS, CANCELLED</td>
                </tr>
                <tr>
                    <td><span class="badge badge-info">IN_PROGRESS</span></td>
                    <td>FITTING, CANCELLED</td>
                </tr>
                <tr>
                    <td><span class="badge badge-warning">FITTING</span></td>
                    <td>COMPLETED, IN_PROGRESS (revision), CANCELLED</td>
                </tr>
                <tr>
                    <td><span class="badge badge-success">COMPLETED</span></td>
                    <td>‚ùå Kh√¥ng cho ph√©p</td>
                </tr>
                <tr>
                    <td><span class="badge badge-danger">CANCELLED</span></td>
                    <td>‚ùå Kh√¥ng cho ph√©p</td>
                </tr>
            </table>
        </div>

        <!-- 5. Methods -->
        <div class="section" id="methods">
            <h2>5. Chi Ti·∫øt Methods</h2>

            <h3>5.1. list() - T√¨m ki·∫øm ƒë∆°n h√†ng</h3>
            <table>
                <tr>
                    <th>Parameter</th>
                    <th>Type</th>
                    <th>M√¥ t·∫£</th>
                </tr>
                <tr>
                    <td>status</td>
                    <td>OrderStatus</td>
                    <td>L·ªçc theo tr·∫°ng th√°i</td>
                </tr>
                <tr>
                    <td>customerId</td>
                    <td>Long</td>
                    <td>L·ªçc theo kh√°ch h√†ng</td>
                </tr>
                <tr>
                    <td>tailorId</td>
                    <td>Long</td>
                    <td>L·ªçc theo th·ª£ may</td>
                </tr>
                <tr>
                    <td>fromDate</td>
                    <td>Instant</td>
                    <td>T·ª´ ng√†y</td>
                </tr>
                <tr>
                    <td>toDate</td>
                    <td>Instant</td>
                    <td>ƒê·∫øn ng√†y</td>
                </tr>
                <tr>
                    <td>appointmentDate</td>
                    <td>LocalDate</td>
                    <td>Ng√†y h·∫πn</td>
                </tr>
                <tr>
                    <td>dueDate</td>
                    <td>LocalDate</td>
                    <td>Ng√†y giao</td>
                </tr>
                <tr>
                    <td>search</td>
                    <td>String</td>
                    <td>T√¨m ki·∫øm text</td>
                </tr>
                <tr>
                    <td>pageable</td>
                    <td>Pageable</td>
                    <td>Ph√¢n trang</td>
                </tr>
            </table>
            <div class="info-box">
                <strong>Return:</strong> <code>Page&lt;OrderResponse&gt;</code> - Danh s√°ch ƒë∆°n h√†ng c√≥ ph√¢n trang
            </div>

            <h3>5.2. create() - T·∫°o ƒë∆°n h√†ng th·ªß c√¥ng</h3>
            <div class="success-box">
                <strong>X·ª≠ l√Ω t·ª± ƒë·ªông:</strong>
                <ul>
                    <li>Generate order code: <code>ORD-XXXXXXXX</code></li>
                    <li>Set initial status: <code>DRAFT</code></li>
                    <li>Calculate total t·ª´ items</li>
                    <li>Upload files to S3</li>
                    <li>Save measurements</li>
                    <li>Add timeline entry</li>
                    <li><strong>T·ª± ƒë·ªông t·∫°o Invoice</strong></li>
                </ul>
            </div>

            <h3>5.3. createWizard() - T·∫°o ƒë∆°n t·ª´ Wizard</h3>
            <div class="success-box">
                <strong>Kh√°c bi·ªát so v·ªõi create():</strong>
                <ul>
                    <li>Initial status: <code>WAITING_FOR_QUOTE</code> (thay v√¨ DRAFT)</li>
                    <li>T·ª± ƒë·ªông t·∫°o <strong>Appointment</strong></li>
                    <li>X·ª≠ l√Ω productName t·ª´ form</li>
                    <li>Build note t·ª´ wizard data</li>
                </ul>
            </div>

            <h3>5.4. updateStatus() - C·∫≠p nh·∫≠t tr·∫°ng th√°i</h3>
            <div class="warning-box">
                <strong>Validation:</strong> Ki·ªÉm tra transition h·ª£p l·ªá b·∫±ng <code>isTransitionAllowed()</code>
            </div>
            <ul>
                <li>Update status</li>
                <li>Update total n·∫øu c√≥ (cho quote confirmation)</li>
                <li>Auto-calculate deposit 30% n·∫øu ch∆∞a set</li>
                <li>Add timeline entry</li>
            </ul>

            <h3>5.5. tracking() - Theo d√µi ƒë∆°n h√†ng</h3>
            <ul>
                <li>Ki·ªÉm tra quy·ªÅn truy c·∫≠p (customer ownership)</li>
                <li>Return timeline history</li>
                <li>Basic order info</li>
            </ul>

            <h3>5.6. uploadAttachment() - Upload file</h3>
            <ul>
                <li>Upload to S3: <code>orders/{orderId}/{filename}</code></li>
                <li>Save metadata to OrderAttachmentEntity</li>
            </ul>
        </div>

        <!-- 6. Create Flow -->
        <div class="section" id="create-flow">
            <h2>6. Lu·ªìng T·∫°o ƒê∆°n H√†ng Chi Ti·∫øt</h2>

            <div class="mermaid">
                sequenceDiagram
                participant C as Client
                participant Ctrl as OrderController
                participant Svc as OrderServiceImpl
                participant UR as UserRepository
                participant OR as OrderRepository
                participant OIR as OrderItemRepository
                participant S3 as S3StorageService
                participant MR as MeasurementRepository
                participant IS as InvoiceService
                participant DB as Database

                C->>Ctrl: POST /api/orders
                Ctrl->>Svc: create(request, files, currentUserId)

                Note over Svc: 1. Validate Users
                Svc->>UR: findById(customerId)
                UR-->>Svc: CustomerEntity
                Svc->>UR: findById(tailorId)
                UR-->>Svc: TailorEntity

                Note over Svc: 2. Create Order
                Svc->>Svc: generateCode() -> ORD-XXXXXXXX
                Svc->>OR: save(order)
                OR->>DB: INSERT orders
                DB-->>OR: order with ID

                Note over Svc: 3. Create Order Items
                loop For each item
                Svc->>OIR: save(item)
                Svc->>Svc: Calculate subtotal
                end
                Svc->>Svc: Update order.total
                Svc->>OR: save(order)

                Note over Svc: 4. Upload Files
                alt Files provided
                loop For each file
                Svc->>S3: upload(orders/orderId, file)
                S3-->>Svc: URL
                Svc->>DB: Save attachment
                end
                end

                Note over Svc: 5. Save Measurements
                alt Measurement provided
                Svc->>MR: save(measurement)
                end

                Note over Svc: 6. Add Timeline
                Svc->>DB: Save timeline DRAFT

                Note over Svc: 7. Auto Create Invoice
                Svc->>IS: createInvoiceForOrder(order)
                IS-->>Svc: Invoice created

                Svc-->>Ctrl: OrderResponse
                Ctrl-->>C: 200 OK + JSON
            </div>
        </div>

        <!-- 7. Wizard Flow -->
        <div class="section" id="wizard-flow">
            <h2>7. Lu·ªìng T·∫°o Wizard (Frontend Multi-step Form)</h2>

            <div class="mermaid">
                sequenceDiagram
                participant C as Client
                participant Svc as OrderServiceImpl
                participant AS as AppointmentService
                participant IS as InvoiceService
                participant DB as Database

                C->>Svc: createWizard(request, currentUserId)

                Note over Svc: 1. Create Order
                Svc->>Svc: Set status = WAITING_FOR_QUOTE
                Svc->>DB: Save order

                Note over Svc: 2. Create Order Item
                Svc->>Svc: Build item from product info
                Svc->>DB: Save item

                Note over Svc: 3. Save Measurements
                Svc->>DB: Save measurement

                Note over Svc: 4. Add Timeline
                Svc->>DB: Save timeline

                Note over Svc: 5. Auto Create Invoice
                Svc->>IS: createInvoiceForOrder()

                Note over Svc: 6. Auto Create Appointment
                alt Has appointmentDate
                Svc->>AS: create(appointmentRequest)
                Note over AS: Type: fitting/consultation
                Note over AS: Time: 09:00 default
                end

                Svc-->>C: OrderResponse
            </div>

            <h3>Wizard Request Structure</h3>
            <pre><code>{
  "customerId": 123,
  "tailorId": 456,
  "product": {
    "productName": "√Åo d√†i c∆∞·ªõi",
    "description": "√Åo d√†i tr·∫Øng th√™u hoa",
    "budget": 5000000,
    "dueDate": "2024-03-15",
    "appointmentType": "fitting",
    "appointmentTime": "09:00",
    "notes": "Kh√°ch c·∫ßn g·∫•p"
  },
  "measurement": {
    "chest": 95.5,
    "waist": 75.0,
    "hip": 98.0,
    "shoulder": 42.0,
    "height": 165.0,
    "weight": 55.0,
    "note": "D√°ng thon"
  }
}</code></pre>
        </div>

        <!-- 8. Auto Invoice -->
        <div class="section" id="auto-invoice">
            <h2>8. T·ª± ƒê·ªông T·∫°o H√≥a ƒê∆°n</h2>

            <div class="mermaid">
                flowchart TD
                A[Order Created] --> B{Has Items?}
                B -->|No| C[Skip Invoice]
                B -->|Yes| D[Find Staff ID]

                D --> E{Tailor exists?}
                E -->|Yes| F[Use Tailor ID]
                E -->|No| G{Current User is Staff?}
                G -->|Yes| H[Use Current User ID]
                G -->|No| I[Find Default Admin/Staff]

                F --> J[Build Invoice Request]
                H --> J
                I --> J

                J --> K[Create Invoice]
                K --> L{Success?}
                L -->|Yes| M[Log Success]
                L -->|No| N[Log Error - Don't Block Order]

                M --> O[Order Completed]
                N --> O
                C --> O
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Quan tr·ªçng:</strong> L·ªói t·∫°o Invoice <strong>KH√îNG</strong> rollback transaction c·ªßa Order.
                Order v·∫´n ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng, Invoice c√≥ th·ªÉ t·∫°o th·ªß c√¥ng sau.
            </div>

            <h3>Invoice Auto-fill Fields</h3>
            <table>
                <tr>
                    <th>Field</th>
                    <th>Value</th>
                </tr>
                <tr>
                    <td>orderId</td>
                    <td>Order ID v·ª´a t·∫°o</td>
                </tr>
                <tr>
                    <td>customerId</td>
                    <td>T·ª´ order.customer</td>
                </tr>
                <tr>
                    <td>staffId</td>
                    <td>Tailor ‚Üí Current User ‚Üí Default Admin</td>
                </tr>
                <tr>
                    <td>currency</td>
                    <td>"VND" (m·∫∑c ƒë·ªãnh)</td>
                </tr>
                <tr>
                    <td>dueDate</td>
                    <td>Order.dueDate ho·∫∑c +30 ng√†y</td>
                </tr>
                <tr>
                    <td>items</td>
                    <td>Convert t·ª´ OrderItems</td>
                </tr>
            </table>
        </div>

        <!-- 9. Error Handling -->
        <div class="section" id="error-handling">
            <h2>9. X·ª≠ L√Ω L·ªói & Exceptions</h2>

            <table>
                <tr>
                    <th>Scenario</th>
                    <th>Exception</th>
                    <th>Message</th>
                </tr>
                <tr>
                    <td>Order kh√¥ng t·ªìn t·∫°i</td>
                    <td><code>NotFoundException</code></td>
                    <td>"Order not found"</td>
                </tr>
                <tr>
                    <td>Customer kh√¥ng t·ªìn t·∫°i</td>
                    <td><code>NotFoundException</code></td>
                    <td>"Customer not found"</td>
                </tr>
                <tr>
                    <td>Tailor kh√¥ng t·ªìn t·∫°i</td>
                    <td><code>NotFoundException</code></td>
                    <td>"Tailor not found"</td>
                </tr>
                <tr>
                    <td>Kh√¥ng c√≥ items</td>
                    <td><code>BadRequestException</code></td>
                    <td>"Order items is required"</td>
                </tr>
                <tr>
                    <td>Status transition kh√¥ng h·ª£p l·ªá</td>
                    <td><code>BadRequestException</code></td>
                    <td>"Invalid status transition"</td>
                </tr>
                <tr>
                    <td>File r·ªóng</td>
                    <td><code>BadRequestException</code></td>
                    <td>"File is empty"</td>
                </tr>
                <tr>
                    <td>Upload l·ªói</td>
                    <td><code>BadRequestException</code></td>
                    <td>"Failed to upload file: {name}"</td>
                </tr>
                <tr>
                    <td>Customer xem order ng∆∞·ªùi kh√°c</td>
                    <td><code>BadRequestException</code></td>
                    <td>"Access denied"</td>
                </tr>
            </table>

            <h3>Logging</h3>
            <ul>
                <li>‚úÖ <code>Creating order via wizard for customerId: {}, currentUserId: {}</code></li>
                <li>‚úÖ <code>Order saved successfully with id: {}</code></li>
                <li>‚úÖ <code>Successfully created invoice for order {}</code></li>
                <li>‚úÖ <code>Order creation completed successfully. Order ID: {}, Code: {}</code></li>
                <li>‚ö†Ô∏è <code>Failed to create invoice for order {}: {}</code></li>
                <li>‚ö†Ô∏è <code>Error fetching invoice for order {}: {}</code></li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="section" style="text-align: center; margin-top: 40px;">
            <p style="color: #888;">Generated by Antigravity AI Assistant</p>
            <p style="color: #666; font-size: 12px;">Last updated: 2024</p>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: true, htmlLabels: true }
        });
    </script>
</body>

</html>