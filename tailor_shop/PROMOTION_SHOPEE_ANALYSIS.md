# PhÃ¢n TÃ­ch Há»‡ Thá»‘ng MÃ£ Giáº£m GiÃ¡ Shopee & Äá» Xuáº¥t Cáº£i Tiáº¿n

## ğŸ” CÃ¡ch Shopee Hoáº¡t Äá»™ng

### 1. Tá»± Äá»™ng Äá» Xuáº¥t MÃ£ Giáº£m GiÃ¡

**Shopee cÃ³ 3 cÆ¡ cháº¿ chÃ­nh:**

#### a) Tá»± Ä‘á»™ng Ä‘á» xuáº¥t khi xem giá» hÃ ng
- Khi khÃ¡ch hÃ ng vÃ o giá» hÃ ng, Shopee tá»± Ä‘á»™ng hiá»ƒn thá»‹ cÃ¡c mÃ£ cÃ³ thá»ƒ dÃ¹ng
- Hiá»ƒn thá»‹ theo thá»© tá»± Æ°u tiÃªn: mÃ£ giáº£m nhiá»u nháº¥t â†’ mÃ£ dá»… Ä‘áº¡t Ä‘iá»u kiá»‡n nháº¥t
- Hiá»ƒn thá»‹ sá»‘ tiá»n sáº½ Ä‘Æ°á»£c giáº£m ngay trÃªn UI

#### b) Tá»± Ä‘á»™ng apply mÃ£ tá»‘t nháº¥t
- Shopee cÃ³ tÃ­nh nÄƒng "Tá»± Ä‘á»™ng chá»n mÃ£ tá»‘t nháº¥t"
- Há»‡ thá»‘ng tá»± Ä‘á»™ng chá»n mÃ£ giáº£m nhiá»u tiá»n nháº¥t mÃ  khÃ¡ch hÃ ng Ä‘á»§ Ä‘iá»u kiá»‡n
- KhÃ¡ch hÃ ng khÃ´ng cáº§n nháº­p mÃ£, chá»‰ cáº§n báº­t toggle

#### c) Äá» xuáº¥t theo sáº£n pháº©m
- Má»—i sáº£n pháº©m cÃ³ thá»ƒ cÃ³ mÃ£ riÃªng
- Khi xem sáº£n pháº©m, hiá»ƒn thá»‹ "CÃ³ thá»ƒ dÃ¹ng mÃ£ XXX Ä‘á»ƒ giáº£m thÃªm Y%"
- Khi thÃªm vÃ o giá», tá»± Ä‘á»™ng Ä‘á» xuáº¥t mÃ£ Ä‘Ã³

### 2. Trá»« Trá»±c Tiáº¿p VÃ o Sáº£n Pháº©m

**Shopee cÃ³ 2 loáº¡i giáº£m giÃ¡:**

#### a) Product-level discount (Giáº£m giÃ¡ sáº£n pháº©m)
- Giáº£m giÃ¡ Ä‘Æ°á»£c tÃ­nh trá»±c tiáº¿p vÃ o giÃ¡ sáº£n pháº©m
- Hiá»ƒn thá»‹: "GiÃ¡ gá»‘c: 500k â†’ GiÃ¡ sau giáº£m: 400k"
- Ãp dá»¥ng ngay khi xem sáº£n pháº©m, khÃ´ng cáº§n mÃ£

#### b) Order-level discount (Giáº£m giÃ¡ Ä‘Æ¡n hÃ ng)
- Giáº£m giÃ¡ Ä‘Æ°á»£c tÃ­nh trÃªn tá»•ng Ä‘Æ¡n hÃ ng
- Cáº§n nháº­p mÃ£ hoáº·c tá»± Ä‘á»™ng apply
- Trá»« vÃ o tá»•ng tiá»n cuá»‘i cÃ¹ng

### 3. CÆ¡ Cháº¿ Æ¯u TiÃªn

Shopee Ã¡p dá»¥ng theo thá»© tá»±:
1. **Product discount** (giáº£m giÃ¡ sáº£n pháº©m) - Ã¡p dá»¥ng trÆ°á»›c
2. **Order discount** (mÃ£ giáº£m giÃ¡ Ä‘Æ¡n hÃ ng) - Ã¡p dá»¥ng sau
3. **Shipping discount** (giáº£m phÃ­ ship) - Ã¡p dá»¥ng cuá»‘i

---

## ğŸ“Š So SÃ¡nh Vá»›i Module Hiá»‡n Táº¡i

### âœ… ÄÃ£ CÃ³:
- Order-level discount (giáº£m giÃ¡ Ä‘Æ¡n hÃ ng)
- Validate Ä‘iá»u kiá»‡n (min order value, products, categories)
- Usage limits (per user, total)
- Public/Private codes

### âŒ ChÆ°a CÃ³:
- **Tá»± Ä‘á»™ng Ä‘á» xuáº¥t mÃ£** dá»±a trÃªn giá» hÃ ng
- **Product-level discount** (giáº£m trá»±c tiáº¿p vÃ o sáº£n pháº©m)
- **Tá»± Ä‘á»™ng apply mÃ£ tá»‘t nháº¥t**
- **Hiá»ƒn thá»‹ mÃ£ cÃ³ thá»ƒ dÃ¹ng** trong giá» hÃ ng
- **TÃ­nh toÃ¡n discount cho nhiá»u mÃ£** Ä‘á»ƒ chá»n mÃ£ tá»‘t nháº¥t

---

## ğŸš€ Äá» Xuáº¥t Cáº£i Tiáº¿n

### 1. ThÃªm Product-Level Discount

**CÃ¡ch hoáº¡t Ä‘á»™ng:**
- Promotion cÃ³ thá»ƒ gáº¯n trá»±c tiáº¿p vÃ o sáº£n pháº©m
- Khi xem sáº£n pháº©m, tá»± Ä‘á»™ng hiá»ƒn thá»‹ giÃ¡ Ä‘Ã£ giáº£m
- KhÃ´ng cáº§n nháº­p mÃ£, tá»± Ä‘á»™ng Ã¡p dá»¥ng

**Implementation:**
- ThÃªm field `isProductLevel` vÃ o `PromotionEntity`
- Khi list products, join vá»›i promotions Ä‘á»ƒ tÃ­nh giÃ¡ Ä‘Ã£ giáº£m
- Hiá»ƒn thá»‹: "GiÃ¡ gá»‘c: 500k â†’ GiÃ¡ khuyáº¿n mÃ£i: 400k"

### 2. API Tá»± Äá»™ng Äá» Xuáº¥t MÃ£

**Endpoint má»›i:** `GET /api/v1/promotions/suggestions`

**Input:**
- `orderAmount`: Tá»•ng tiá»n giá» hÃ ng
- `productIds`: Danh sÃ¡ch ID sáº£n pháº©m
- `categoryIds`: Danh sÃ¡ch category

**Output:**
- Danh sÃ¡ch mÃ£ cÃ³ thá»ƒ dÃ¹ng, sáº¯p xáº¿p theo discount amount (giáº£m nhiá»u nháº¥t trÆ°á»›c)
- Má»—i mÃ£ hiá»ƒn thá»‹: code, name, discountAmount, finalAmount

### 3. API Tá»± Äá»™ng Apply MÃ£ Tá»‘t Nháº¥t

**Endpoint má»›i:** `POST /api/v1/promotions/auto-apply`

**Input:** Giá»‘ng nhÆ° suggestions
**Output:** MÃ£ Ä‘Æ°á»£c chá»n tá»± Ä‘á»™ng vÃ  discount amount

**Logic:**
- TÃ¬m táº¥t cáº£ mÃ£ Ä‘á»§ Ä‘iá»u kiá»‡n
- TÃ­nh discount cho tá»«ng mÃ£
- Chá»n mÃ£ giáº£m nhiá»u tiá»n nháº¥t
- Validate usage limits
- Return mÃ£ tá»‘t nháº¥t

### 4. Cáº£i Tiáº¿n Apply Promo Code

**Hiá»‡n táº¡i:** Chá»‰ apply 1 mÃ£
**Cáº£i tiáº¿n:** Há»— trá»£ apply nhiá»u mÃ£ (náº¿u cho phÃ©p)

**Logic:**
- Má»™t sá»‘ mÃ£ cÃ³ thá»ƒ combine vá»›i mÃ£ khÃ¡c
- ThÃªm field `canCombineWithOthers` vÃ o `PromotionEntity`
- TÃ­nh tá»•ng discount tá»« nhiá»u mÃ£

### 5. Hiá»ƒn Thá»‹ MÃ£ Trong Giá» HÃ ng

**Endpoint:** `GET /api/v1/promotions/available-for-cart`

**Input:**
- `orderAmount`
- `productIds`
- `categoryIds`
- `userId` (optional)

**Output:**
- Danh sÃ¡ch mÃ£ cÃ³ thá»ƒ dÃ¹ng
- Má»—i mÃ£ cÃ³: code, name, discountAmount, message
- Sáº¯p xáº¿p theo priority vÃ  discount amount

---

## ğŸ’¡ VÃ­ Dá»¥ Sá»­ Dá»¥ng

### TÃ¬nh huá»‘ng 1: KhÃ¡ch hÃ ng xem giá» hÃ ng

**BÆ°á»›c 1:** Frontend gá»i
```
GET /api/v1/promotions/available-for-cart?orderAmount=600000&productIds=1,2,3
```

**Response:**
```json
{
  "content": [
    {
      "code": "GIAM20",
      "name": "Giáº£m 20%",
      "discountAmount": 100000,
      "finalAmount": 500000,
      "message": "Báº¡n cÃ³ thá»ƒ giáº£m thÃªm 100,000Ä‘",
      "isEligible": true
    },
    {
      "code": "GIAM50K",
      "name": "Giáº£m 50k",
      "discountAmount": 50000,
      "finalAmount": 550000,
      "message": "Báº¡n cÃ³ thá»ƒ giáº£m thÃªm 50,000Ä‘",
      "isEligible": true
    }
  ]
}
```

**BÆ°á»›c 2:** Frontend hiá»ƒn thá»‹ danh sÃ¡ch mÃ£, khÃ¡ch hÃ ng chá»n

**BÆ°á»›c 3:** Hoáº·c khÃ¡ch hÃ ng báº­t "Tá»± Ä‘á»™ng chá»n mÃ£ tá»‘t nháº¥t"

**BÆ°á»›c 4:** Frontend gá»i
```
POST /api/v1/promotions/auto-apply
{
  "orderAmount": 600000,
  "productIds": [1, 2, 3]
}
```

**Response:**
```json
{
  "promotionId": 1,
  "code": "GIAM20",
  "discountAmount": 100000,
  "finalAmount": 500000,
  "message": "ÄÃ£ tá»± Ä‘á»™ng Ã¡p dá»¥ng mÃ£ GIAM20, giáº£m 100,000Ä‘"
}
```

### TÃ¬nh huá»‘ng 2: Product-level discount

**Khi xem sáº£n pháº©m:**
```
GET /api/v1/products/ao-so-mi-truyen-thong
```

**Response cÃ³ thÃªm:**
```json
{
  "id": 1,
  "name": "Ão SÆ¡ Mi",
  "originalPrice": 500000,
  "discountedPrice": 400000,
  "discount": {
    "promotionId": 5,
    "code": "SHIRT_SALE",
    "discountAmount": 100000,
    "discountPercentage": 20
  }
}
```

---

## ğŸ”§ Implementation Plan

### Phase 1: Product-Level Discount
1. ThÃªm field `isProductLevel` vÃ o `PromotionEntity`
2. ThÃªm field `productDiscount` vÃ o `ProductResponse`
3. Modify `ProductService` Ä‘á»ƒ join vá»›i promotions
4. TÃ­nh giÃ¡ Ä‘Ã£ giáº£m khi list/detail product

### Phase 2: Auto Suggest
1. Táº¡o endpoint `GET /api/v1/promotions/suggestions`
2. Táº¡o endpoint `GET /api/v1/promotions/available-for-cart`
3. Logic tÃ¬m mÃ£ Ä‘á»§ Ä‘iá»u kiá»‡n vÃ  tÃ­nh discount
4. Sáº¯p xáº¿p theo discount amount

### Phase 3: Auto Apply
1. Táº¡o endpoint `POST /api/v1/promotions/auto-apply`
2. Logic chá»n mÃ£ tá»‘t nháº¥t
3. Validate vÃ  return

### Phase 4: Multiple Promotions
1. ThÃªm field `canCombineWithOthers` vÃ o `PromotionEntity`
2. Modify logic apply Ä‘á»ƒ há»— trá»£ nhiá»u mÃ£
3. TÃ­nh tá»•ng discount

---

## ğŸ“ Káº¿t Luáº­n

### âœ… ÄÃ£ Implement

**Module hiá»‡n táº¡i Ä‘Ã£ cÃ³ Ä‘áº§y Ä‘á»§ cÃ¡c tÃ­nh nÄƒng chÃ­nh:**

1. âœ… **Auto suggest** - Tá»± Ä‘á»™ng Ä‘á» xuáº¥t mÃ£
   - API: `GET /api/v1/promotions/suggestions`
   - API: `GET /api/v1/promotions/available-for-cart`
   - Tá»± Ä‘á»™ng tÃ¬m mÃ£ Ä‘á»§ Ä‘iá»u kiá»‡n dá»±a trÃªn giá» hÃ ng
   - Sáº¯p xáº¿p theo discount amount (giáº£m nhiá»u nháº¥t trÆ°á»›c)

2. âœ… **Auto apply** - Tá»± Ä‘á»™ng chá»n mÃ£ tá»‘t nháº¥t
   - API: `POST /api/v1/promotions/auto-apply`
   - Tá»± Ä‘á»™ng chá»n mÃ£ giáº£m nhiá»u tiá»n nháº¥t
   - Validate usage limits trÆ°á»›c khi apply

3. âœ… **Cart integration** - Hiá»ƒn thá»‹ mÃ£ trong giá» hÃ ng
   - API `available-for-cart` tráº£ vá» mÃ£ cÃ³ thá»ƒ dÃ¹ng cho giá» hÃ ng hiá»‡n táº¡i
   - Hiá»ƒn thá»‹ rÃµ sá»‘ tiá»n sáº½ Ä‘Æ°á»£c giáº£m
   - Chá»‰ hiá»ƒn thá»‹ mÃ£ Ä‘á»§ Ä‘iá»u kiá»‡n (`isEligible = true`)

### ğŸ”„ ChÆ°a Implement (CÃ³ thá»ƒ bá»• sung sau)

1. â³ **Product-level discount** - Giáº£m trá»±c tiáº¿p vÃ o sáº£n pháº©m
   - Cáº§n thÃªm field `isProductLevel` vÃ o `PromotionEntity`
   - Cáº§n modify `ProductService` Ä‘á»ƒ join vá»›i promotions
   - TÃ­nh giÃ¡ Ä‘Ã£ giáº£m khi list/detail product
   - **Æ¯u tiÃªn tháº¥p** - CÃ³ thá»ƒ lÃ m sau

### ğŸ¯ Tráº¡ng ThÃ¡i Hiá»‡n Táº¡i

**Há»‡ thá»‘ng Ä‘Ã£ cÃ³ Ä‘áº§y Ä‘á»§ tÃ­nh nÄƒng cá»‘t lÃµi giá»‘ng Shopee:**
- âœ… Customer cÃ³ thá»ƒ xem danh sÃ¡ch mÃ£ Ä‘ang active
- âœ… Tá»± Ä‘á»™ng Ä‘á» xuáº¥t mÃ£ khi vÃ o giá» hÃ ng
- âœ… Tá»± Ä‘á»™ng apply mÃ£ tá»‘t nháº¥t
- âœ… Nháº­p mÃ£ thá»§ cÃ´ng
- âœ… Validate Ä‘áº§y Ä‘á»§ (dates, limits, conditions)
- âœ… Theo dÃµi usage history

**Nhá»¯ng tÃ­nh nÄƒng nÃ y Ä‘Ã£ lÃ m cho há»‡ thá»‘ng giá»‘ng Shopee vÃ  tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng tá»‘t hÆ¡n!**

### ğŸ“‹ Next Steps (Optional)

Náº¿u muá»‘n bá»• sung Product-level discount:

    1. **Database**: ThÃªm field `is_product_level` vÃ o báº£ng `promotions`
    2. **Entity**: ThÃªm field `isProductLevel` vÃ o `PromotionEntity`
    3. **Service**: Modify `ProductService` Ä‘á»ƒ:
    - Join vá»›i `promotions` khi list/detail product
    - TÃ­nh `discountedPrice` náº¿u cÃ³ promotion active
    - Return `originalPrice` vÃ  `discountedPrice` trong response
    4. **DTO**: ThÃªm fields vÃ o `ProductResponse`:
    ```java
    private BigDecimal originalPrice;
    private BigDecimal discountedPrice;
    private PromotionInfo discount; // promotion info if any
    ```

**LÆ°u Ã½**: Product-level discount lÃ  tÃ­nh nÄƒng bá»• sung, khÃ´ng báº¯t buá»™c. Há»‡ thá»‘ng hiá»‡n táº¡i Ä‘Ã£ Ä‘á»§ Ä‘á»ƒ sá»­ dá»¥ng nhÆ° Shopee.

