<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FabricService - T√†i Li·ªáu Chi Ti·∫øt</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2e0a 0%, #2d4e1a 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #8bc34a;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(139, 195, 74, 0.3);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        h2 {
            color: #ffd700;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
        }

        h3 {
            color: #00ff88;
            margin: 25px 0 15px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mermaid {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(139, 195, 74, 0.2);
            color: #8bc34a;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            color: #00ff88;
            font-family: 'Consolas', monospace;
        }

        pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .success-box {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 217, 255, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
            margin: 15px 0;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }

        .info-box {
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 217, 255, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
        }

        ul,
        ol {
            padding-left: 25px;
            margin: 10px 0;
        }

        li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }

        .badge-pending {
            background: #ffc107;
            color: black;
        }

        .badge-approved {
            background: #28a745;
            color: white;
        }

        .badge-rejected {
            background: #dc3545;
            color: white;
        }

        .badge-completed {
            background: #17a2b8;
            color: white;
        }

        .badge-cancelled {
            background: #6c757d;
            color: white;
        }

        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 10px;
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #8bc34a;
        }

        .stat-label {
            color: #888;
            margin-top: 5px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #00d9ff;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Quay l·∫°i danh s√°ch</a>
        <h1>üß∂ FabricService - T√†i Li·ªáu Chi Ti·∫øt</h1>
        <p class="subtitle">Module qu·∫£n l√Ω v·∫£i v·ªõi Inventory v√† Hold Request System</p>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">736</div>
                <div class="stat-label">D√≤ng code</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">16</div>
                <div class="stat-label">Methods</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">6</div>
                <div class="stat-label">Dependencies</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">3</div>
                <div class="stat-label">Sub-systems</div>
            </div>
        </div>

        <!-- 1. Overview -->
        <div class="section">
            <h2>1. T·ªïng Quan</h2>
            <p><code>FabricServiceImpl</code> qu·∫£n l√Ω to√†n b·ªô th√¥ng tin v·ªÅ v·∫£i trong h·ªá th·ªëng Tailor Shop, bao g·ªìm:</p>

            <div class="success-box">
                <strong>‚úÖ 3 Sub-systems ch√≠nh:</strong>
                <ul>
                    <li><strong>Fabric Management</strong> - CRUD v·∫£i, filter, search</li>
                    <li><strong>Inventory Management</strong> - Qu·∫£n l√Ω t·ªìn kho theo location</li>
                    <li><strong>Hold Request System</strong> - ƒê·∫∑t gi·ªØ v·∫£i ho·∫∑c ƒë·∫∑t l·ªãch xem h√†ng</li>
                </ul>
            </div>
        </div>

        <!-- 2. Architecture -->
        <div class="section">
            <h2>2. Ki·∫øn Tr√∫c H·ªá Th·ªëng</h2>

            <div class="mermaid">
                graph TB
                subgraph "FabricServiceImpl"
                FS[FabricServiceImpl]

                subgraph "Fabric CRUD"
                F1[list - Filter & Search]
                F2[detail / detailByCode / detailBySlug]
                F3[create]
                F4[update]
                F5[delete - Soft Delete]
                F6[incrementViewCount]
                end

                subgraph "Inventory Management"
                I1[getInventory]
                I2[updateInventory]
                end

                subgraph "Hold Request System"
                H1[createHoldRequest]
                H2[listHoldRequests]
                H3[getHoldRequestDetail]
                H4[updateHoldRequestStatus]
                H5[cancelHoldRequest]
                end

                subgraph "Promo Integration"
                P1[applyPromoCode]
                end
                end

                subgraph "Repositories"
                FR[FabricRepository]
                FIR[FabricInventoryRepository]
                FHR[FabricHoldRequestRepository]
                UR[UserRepository]
                end

                subgraph "External Services"
                PS[PromotionService]
                end

                FS --> FR
                FS --> FIR
                FS --> FHR
                FS --> UR
                P1 --> PS
            </div>
        </div>

        <!-- 3. Entity Relationships -->
        <div class="section">
            <h2>3. Entity Relationships</h2>

            <div class="mermaid">
                erDiagram
                FabricEntity ||--o{ FabricInventoryEntity : "has inventory"
                FabricEntity ||--o{ FabricHoldRequestEntity : "has requests"
                FabricEntity }o--|| UserEntity : "createdBy"
                FabricHoldRequestEntity }o--|| UserEntity : "requested by"
                FabricHoldRequestEntity }o--o| UserEntity : "handled by"

                FabricEntity {
                Long id PK
                String code UK
                String name
                String slug UK
                String description
                String category
                String material
                String color
                String pattern
                BigDecimal width
                BigDecimal weight
                BigDecimal pricePerMeter
                String image
                String gallery JSON
                String origin
                String careInstructions
                Boolean isAvailable
                Boolean isFeatured
                Integer displayOrder
                Integer viewCount
                Boolean isDeleted
                }

                FabricInventoryEntity {
                Long id PK
                Long fabricId FK
                String location
                BigDecimal quantity
                BigDecimal reservedQuantity
                BigDecimal minStockLevel
                BigDecimal maxStockLevel
                String unit
                OffsetDateTime lastRestockedAt
                String notes
                }

                FabricHoldRequestEntity {
                Long id PK
                Long fabricId FK
                Long userId FK
                FabricHoldRequestType type
                BigDecimal quantity
                LocalDate requestedDate
                LocalTime requestedTime
                FabricHoldRequestStatus status
                LocalDate expiryDate
                String notes
                String staffNotes
                Long handledById FK
                OffsetDateTime handledAt
                }
            </div>
        </div>

        <!-- 4. Fabric Filter & Search -->
        <div class="section">
            <h2>4. Fabric Filter & Search</h2>

            <h3>Filter Parameters</h3>
            <table>
                <tr>
                    <th>Parameter</th>
                    <th>Type</th>
                    <th>M√¥ t·∫£</th>
                </tr>
                <tr>
                    <td>category</td>
                    <td>String</td>
                    <td>Lo·∫°i v·∫£i (cotton, silk, linen...)</td>
                </tr>
                <tr>
                    <td>color</td>
                    <td>String</td>
                    <td>M√†u s·∫Øc</td>
                </tr>
                <tr>
                    <td>pattern</td>
                    <td>String</td>
                    <td>H·ªça ti·∫øt (solid, striped, checked...)</td>
                </tr>
                <tr>
                    <td>material</td>
                    <td>String</td>
                    <td>Ch·∫•t li·ªáu</td>
                </tr>
                <tr>
                    <td>origin</td>
                    <td>String</td>
                    <td>Xu·∫•t x·ª©</td>
                </tr>
                <tr>
                    <td>isAvailable</td>
                    <td>Boolean</td>
                    <td>C√≤n h√†ng?</td>
                </tr>
                <tr>
                    <td>isFeatured</td>
                    <td>Boolean</td>
                    <td>N·ªïi b·∫≠t?</td>
                </tr>
                <tr>
                    <td>minPrice</td>
                    <td>BigDecimal</td>
                    <td>Gi√° t·ª´</td>
                </tr>
                <tr>
                    <td>maxPrice</td>
                    <td>BigDecimal</td>
                    <td>Gi√° ƒë·∫øn</td>
                </tr>
                <tr>
                    <td>keyword</td>
                    <td>String</td>
                    <td>T√¨m ki·∫øm text</td>
                </tr>
            </table>
        </div>

        <!-- 5. Inventory System -->
        <div class="section">
            <h2>5. Inventory Management System</h2>

            <div class="mermaid">
                flowchart LR
                subgraph "Stock Calculation"
                A[quantity] --> D[availableQuantity]
                B[reservedQuantity] --> D
                D --> |"quantity - reserved"| E[Available]
                end

                subgraph "Low Stock Alert"
                F[quantity] --> G{quantity < minStockLevel?} G -->|Yes| H[isLowStock = true]
                    G -->|No| I[isLowStock = false]
                    end
            </div>

            <h3>Inventory Features</h3>
            <ul>
                <li><strong>Multi-location</strong> - Qu·∫£n l√Ω t·ªìn kho theo t·ª´ng kho/location</li>
                <li><strong>Reserved Quantity</strong> - S·ªë l∆∞·ª£ng ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t gi·ªØ</li>
                <li><strong>Min/Max Stock Level</strong> - M·ª©c t·ªìn kho t·ªëi thi·ªÉu/t·ªëi ƒëa</li>
                <li><strong>Low Stock Alert</strong> - C·∫£nh b√°o khi t·ªìn kho th·∫•p</li>
                <li><strong>Last Restocked</strong> - Th·ªùi ƒëi·ªÉm nh·∫≠p h√†ng g·∫ßn nh·∫•t</li>
            </ul>

            <pre><code>availableQuantity = quantity - reservedQuantity
isLowStock = quantity < minStockLevel</code></pre>
        </div>

        <!-- 6. Hold Request System -->
        <div class="section">
            <h2>6. Hold Request System</h2>

            <h3>Request Types</h3>
            <table>
                <tr>
                    <th>Type</th>
                    <th>M√¥ t·∫£</th>
                    <th>Required Fields</th>
                </tr>
                <tr>
                    <td><strong>HOLD</strong></td>
                    <td>ƒê·∫∑t gi·ªØ v·∫£i trong th·ªùi gian nh·∫•t ƒë·ªãnh</td>
                    <td>quantity, expiryDate (default 7 ng√†y)</td>
                </tr>
                <tr>
                    <td><strong>VISIT</strong></td>
                    <td>ƒê·∫∑t l·ªãch ƒë·∫øn xem h√†ng tr·ª±c ti·∫øp</td>
                    <td>requestedDate, requestedTime</td>
                </tr>
            </table>

            <h3>Request Status Flow</h3>
            <div class="mermaid">
                stateDiagram-v2
                [*] --> PENDING : Customer t·∫°o request

                PENDING --> APPROVED : Staff duy·ªát
                PENDING --> REJECTED : Staff t·ª´ ch·ªëi
                PENDING --> CANCELLED : Customer h·ªßy

                APPROVED --> COMPLETED : Ho√†n th√†nh giao d·ªãch
                APPROVED --> CANCELLED : Customer h·ªßy

                COMPLETED --> [*]
                REJECTED --> [*]
                CANCELLED --> [*]
            </div>

            <h3>Status Badges</h3>
            <p>
                <span class="badge badge-pending">PENDING</span> - ƒêang ch·ªù duy·ªát<br>
                <span class="badge badge-approved">APPROVED</span> - ƒê√£ duy·ªát<br>
                <span class="badge badge-rejected">REJECTED</span> - T·ª´ ch·ªëi<br>
                <span class="badge badge-completed">COMPLETED</span> - Ho√†n th√†nh<br>
                <span class="badge badge-cancelled">CANCELLED</span> - ƒê√£ h·ªßy
            </p>

            <h3>Hold Request Flow</h3>
            <div class="mermaid">
                sequenceDiagram
                participant C as Customer
                participant S as FabricService
                participant FIR as InventoryRepo
                participant FHR as HoldRequestRepo
                participant Staff

                C->>S: createHoldRequest(HOLD, quantity)
                S->>FIR: Check available quantity
                FIR-->>S: totalQuantity - totalReserved

                alt Insufficient quantity
                S-->>C: BadRequestException
                else Sufficient
                S->>FHR: Save request (PENDING)
                FHR-->>S: Saved entity
                S-->>C: HoldRequestResponse
                end

                Staff->>S: updateHoldRequestStatus(id, APPROVED)
                S->>FIR: reservedQuantity += quantity
                S->>FHR: Update status
                S-->>Staff: HoldRequestResponse
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Quan tr·ªçng:</strong> Khi HOLD request ƒë∆∞·ª£c APPROVED, reserved quantity s·∫Ω tƒÉng l√™n.
                Khi CANCELLED, reserved quantity s·∫Ω ƒë∆∞·ª£c release.
            </div>
        </div>

        <!-- 7. Soft Delete -->
        <div class="section">
            <h2>7. Soft Delete Strategy</h2>

            <div class="info-box">
                <strong>üí° Soft Delete:</strong> Thay v√¨ x√≥a th·ª±c s·ª±, system s·∫Ω:
                <ol>
                    <li>Set <code>isDeleted = true</code></li>
                    <li>Append timestamp v√†o code: <code>FABRIC-001_DEL_1704200000000</code></li>
                    <li>Append timestamp v√†o slug: <code>vai-cotton_DEL_1704200000000</code></li>
                </ol>
                ƒêi·ªÅu n√†y cho ph√©p t√°i s·ª≠ d·ª•ng code/slug trong t∆∞∆°ng lai.
            </div>
        </div>

        <!-- 8. Promo Code Integration -->
        <div class="section">
            <h2>8. Promo Code Integration</h2>

            <div class="mermaid">
                sequenceDiagram
                participant C as Customer
                participant FS as FabricService
                participant PS as PromotionService

                C->>FS: applyPromoCode(fabricId, quantity, promoCode)
                FS->>FS: Validate fabric & quantity
                FS->>FS: Calculate subtotal = price * quantity
                FS->>PS: applyPromoCode(code, subtotal, productIds, categoryIds)
                PS-->>FS: ApplyPromoCodeResponse (discountAmount, finalAmount)
                FS-->>C: FabricOrderResponse
            </div>
        </div>

        <!-- 9. Error Handling -->
        <div class="section">
            <h2>9. Error Handling</h2>

            <table>
                <tr>
                    <th>Scenario</th>
                    <th>Exception</th>
                </tr>
                <tr>
                    <td>Fabric kh√¥ng t·ªìn t·∫°i</td>
                    <td><code>NotFoundException("Fabric not found")</code></td>
                </tr>
                <tr>
                    <td>Code ƒë√£ t·ªìn t·∫°i</td>
                    <td><code>BadRequestException("Fabric code already exists")</code></td>
                </tr>
                <tr>
                    <td>Slug ƒë√£ t·ªìn t·∫°i</td>
                    <td><code>BadRequestException("Slug already exists")</code></td>
                </tr>
                <tr>
                    <td>V·∫£i kh√¥ng available</td>
                    <td><code>BadRequestException("Fabric is not available")</code></td>
                </tr>
                <tr>
                    <td>HOLD request thi·∫øu quantity</td>
                    <td><code>BadRequestException("Quantity is required for HOLD request")</code></td>
                </tr>
                <tr>
                    <td>VISIT request thi·∫øu date</td>
                    <td><code>BadRequestException("Requested date is required for VISIT request")</code></td>
                </tr>
                <tr>
                    <td>Date trong qu√° kh·ª©</td>
                    <td><code>BadRequestException("Requested date cannot be in the past")</code></td>
                </tr>
                <tr>
                    <td>Kh√¥ng ƒë·ªß h√†ng</td>
                    <td><code>BadRequestException("Insufficient quantity. Available: X")</code></td>
                </tr>
                <tr>
                    <td>H·ªßy request ng∆∞·ªùi kh√°c</td>
                    <td><code>BadRequestException("You can only cancel your own requests")</code></td>
                </tr>
                <tr>
                    <td>Update completed/cancelled request</td>
                    <td><code>BadRequestException("Cannot update completed or cancelled request")</code></td>
                </tr>
            </table>
        </div>

        <!-- 10. Logging -->
        <div class="section">
            <h2>10. Logging v·ªõi TraceId</h2>

            <div class="info-box">
                <strong>üí° TraceId:</strong> M·ªçi log ƒë·ªÅu c√≥ TraceId ƒë·ªÉ d·ªÖ d√†ng trace request qua c√°c service.
            </div>

            <ul>
                <li>‚úÖ <code>[TraceId: {}] Fabric created: id={}, code={}, name={}</code></li>
                <li>‚úÖ <code>[TraceId: {}] Fabric updated: id={}, code={}</code></li>
                <li>‚úÖ <code>[TraceId: {}] Fabric deleted: id={}, code={}</code></li>
                <li>‚úÖ <code>[TraceId: {}] Fabric inventory updated: fabricId={}, location={}, quantity={}</code></li>
                <li>‚úÖ <code>[TraceId: {}] Fabric hold request created: id={}, type={}, fabricId={}, userId={}</code>
                </li>
                <li>‚úÖ <code>[TraceId: {}] Hold request status updated: id={}, status={}, handledBy={}</code></li>
                <li>‚úÖ <code>[TraceId: {}] Hold request cancelled: id={}, userId={}</code></li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="section" style="text-align: center; margin-top: 40px;">
            <p style="color: #888;">Generated by Antigravity AI Assistant</p>
            <a href="index.html" style="color: #00d9ff;">‚Üê Quay l·∫°i danh s√°ch</a>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
</body>

</html>