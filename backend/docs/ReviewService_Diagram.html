<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReviewService - T√†i Li·ªáu Chi Ti·∫øt</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        h2 {
            color: #ffd700;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
        }

        h3 {
            color: #00ff88;
            margin: 25px 0 15px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mermaid {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            color: #00ff88;
            font-family: 'Consolas', monospace;
        }

        pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        pre code {
            padding: 0;
            background: transparent;
        }

        .success-box {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 217, 255, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
            margin: 15px 0;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }

        .info-box {
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 217, 255, 0.1));
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
        }

        ul,
        ol {
            padding-left: 25px;
            margin: 10px 0;
        }

        li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }

        .badge-primary {
            background: #007bff;
            color: white;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: black;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .back-link {
            display: inline-block;
            color: #00d9ff;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 10px 20px;
            border: 1px solid #00d9ff;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        footer {
            text-align: center;
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #666;
        }

        .star-rating {
            color: #ffd700;
            font-size: 1.2em;
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Quay l·∫°i trang ch√≠nh</a>

        <h1>‚≠ê ReviewService</h1>
        <p class="subtitle">H·ªá th·ªëng ƒê√°nh gi√° - Product Reviews, Order Reviews, Shopee-like Features</p>

        <!-- Overview Section -->
        <div class="section">
            <h2>üìã T·ªïng Quan</h2>
            <p>ReviewService qu·∫£n l√Ω h·ªá th·ªëng ƒë√°nh gi√° s·∫£n ph·∫©m v√† ƒë∆°n h√†ng v·ªõi c√°c t√≠nh nƒÉng gi·ªëng Shopee:</p>
            
            <div class="success-box">
                <strong>‚ú® Key Features:</strong>
                <ul>
                    <li><strong>Multiple Review Types:</strong> Product, Order, Image Asset</li>
                    <li><strong>Rating System:</strong> 1-5 stars v·ªõi th·ªëng k√™ chi ti·∫øt</li>
                    <li><strong>Review Images:</strong> H·ªó tr·ª£ upload ·∫£nh ƒë√°nh gi√°</li>
                    <li><strong>Shop Reply:</strong> C·ª≠a h√†ng c√≥ th·ªÉ ph·∫£n h·ªìi review</li>
                    <li><strong>Helpful Votes:</strong> Ng∆∞·ªùi d√πng vote review h·ªØu √≠ch</li>
                    <li><strong>Moderation:</strong> Duy·ªát review tr∆∞·ªõc khi public</li>
                    <li><strong>Anonymous Reviews:</strong> H·ªó tr·ª£ ƒë√°nh gi√° ·∫©n danh</li>
                </ul>
            </div>
        </div>

        <!-- Architecture Diagram -->
        <div class="section">
            <h2>üèóÔ∏è Ki·∫øn Tr√∫c T·ªïng Quan</h2>
            <div class="mermaid">
flowchart TB
    subgraph Client["üì± Client"]
        FE[Frontend App]
    end

    subgraph Controller["üéÆ Controller Layer"]
        RC[ReviewController]
    end

    subgraph Service["‚öôÔ∏è Service Layer"]
        RS[ReviewService]
    end

    subgraph Events["üì° Event System"]
        RCE[ReviewCreatedEvent]
    end

    subgraph Repository["üíæ Repository Layer"]
        RR[ReviewRepository]
        RIR[ReviewImageRepository]
        RHVR[ReviewHelpfulVoteRepository]
        PR[ProductRepository]
        OR[OrderRepository]
        IAR[ImageAssetRepository]
        UR[UserRepository]
    end

    FE --> RC
    RC --> RS
    RS --> RCE
    RS --> RR
    RS --> RIR
    RS --> RHVR
    RS --> PR
    RS --> OR
    RS --> IAR
    RS --> UR
            </div>
        </div>

        <!-- Review Types -->
        <div class="section">
            <h2>üìå Review Types</h2>
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>M√¥ t·∫£</th>
                        <th>Target</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>PRODUCT</code></td>
                        <td>ƒê√°nh gi√° s·∫£n ph·∫©m may s·∫µn</td>
                        <td>ProductEntity</td>
                    </tr>
                    <tr>
                        <td><code>ORDER</code></td>
                        <td>ƒê√°nh gi√° ƒë∆°n h√†ng may ƒëo</td>
                        <td>OrderEntity</td>
                    </tr>
                    <tr>
                        <td><code>IMAGE_ASSET</code></td>
                        <td>ƒê√°nh gi√° m·∫´u thi·∫øt k·∫ø</td>
                        <td>ImageAssetEntity</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Review Status -->
        <div class="section">
            <h2>üìä Review Status Flow</h2>
            <div class="mermaid">
stateDiagram-v2
    [*] --> PENDING: Create Review
    
    PENDING --> APPROVED: Moderate (approve)
    PENDING --> REJECTED: Moderate (reject)
    
    APPROVED --> HIDDEN: Moderate (hide)
    HIDDEN --> APPROVED: Moderate (unhide)
    
    APPROVED --> [*]: Delete
    REJECTED --> [*]: Delete
    HIDDEN --> [*]: Delete
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>M√¥ t·∫£</th>
                        <th>Visibility</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-warning">PENDING</span></td>
                        <td>Ch·ªù duy·ªát</td>
                        <td>Ch·ªâ owner v√† admin th·∫•y</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">APPROVED</span></td>
                        <td>ƒê√£ duy·ªát</td>
                        <td>Public</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">REJECTED</span></td>
                        <td>B·ªã t·ª´ ch·ªëi</td>
                        <td>Ch·ªâ owner th·∫•y</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-secondary">HIDDEN</span></td>
                        <td>·∫®n t·∫°m th·ªùi</td>
                        <td>Ch·ªâ admin th·∫•y</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- API Endpoints -->
        <div class="section">
            <h2>üåê API Endpoints</h2>
            <table>
                <thead>
                    <tr>
                        <th>Method</th>
                        <th>Endpoint</th>
                        <th>M√¥ t·∫£</th>
                        <th>Auth</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-primary">GET</span></td>
                        <td><code>/api/v1/reviews</code></td>
                        <td>Danh s√°ch reviews (filter)</td>
                        <td>Public</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-primary">GET</span></td>
                        <td><code>/api/v1/reviews/{id}</code></td>
                        <td>Chi ti·∫øt review</td>
                        <td>Public</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">POST</span></td>
                        <td><code>/api/v1/reviews/products/{productId}</code></td>
                        <td>ƒê√°nh gi√° s·∫£n ph·∫©m</td>
                        <td>CUSTOMER</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">POST</span></td>
                        <td><code>/api/v1/reviews/orders/{orderId}</code></td>
                        <td>ƒê√°nh gi√° ƒë∆°n h√†ng</td>
                        <td>CUSTOMER</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">POST</span></td>
                        <td><code>/api/v1/reviews/image-assets/{id}</code></td>
                        <td>ƒê√°nh gi√° m·∫´u thi·∫øt k·∫ø</td>
                        <td>CUSTOMER</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">PUT</span></td>
                        <td><code>/api/v1/reviews/{id}</code></td>
                        <td>C·∫≠p nh·∫≠t review (ch·ªâ owner)</td>
                        <td>CUSTOMER</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">DELETE</span></td>
                        <td><code>/api/v1/reviews/{id}</code></td>
                        <td>X√≥a review (ch·ªâ owner)</td>
                        <td>CUSTOMER</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">POST</span></td>
                        <td><code>/api/v1/reviews/{id}/reply</code></td>
                        <td>Shop tr·∫£ l·ªùi review</td>
                        <td>ADMIN, STAFF</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">POST</span></td>
                        <td><code>/api/v1/reviews/{id}/helpful</code></td>
                        <td>Vote h·ªØu √≠ch</td>
                        <td>Authenticated</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">DELETE</span></td>
                        <td><code>/api/v1/reviews/{id}/helpful</code></td>
                        <td>B·ªè vote h·ªØu √≠ch</td>
                        <td>Authenticated</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">PATCH</span></td>
                        <td><code>/api/v1/reviews/{id}/moderate</code></td>
                        <td>Duy·ªát/t·ª´ ch·ªëi/·∫©n review</td>
                        <td>ADMIN</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-primary">GET</span></td>
                        <td><code>/api/v1/reviews/statistics</code></td>
                        <td>Th·ªëng k√™ ƒë√°nh gi√°</td>
                        <td>Public</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Create Review Flow -->
        <div class="section">
            <h2>üîÑ Create Product Review Flow</h2>
            <div class="mermaid">
sequenceDiagram
    participant C as Customer
    participant RC as ReviewController
    participant RS as ReviewService
    participant PR as ProductRepository
    participant RR as ReviewRepository
    participant RIR as ReviewImageRepository
    participant EP as EventPublisher

    C->>RC: POST /reviews/products/{productId} {rating, comment, images}
    RC->>RS: createProductReview(productId, request, userId)
    
    RS->>PR: findById(productId)
    PR-->>RS: ProductEntity
    
    RS->>RR: findByProductIdAndUserIdAndIsDeletedFalse(productId, userId)
    alt Already Reviewed
        RR-->>RS: existingReview
        RS-->>C: 400 Bad Request (Already reviewed)
    else Not Reviewed
        RR-->>RS: null
        
        RS->>RS: Create ReviewEntity
        Note over RS: rating, title, comment, isAnonymous
        Note over RS: status = PENDING
        Note over RS: isVerifiedPurchase = check order history
        
        RS->>RR: save(reviewEntity)
        RR-->>RS: savedReview
        
        alt Has Images
            RS->>RIR: saveAll(reviewImages)
        end
        
        RS->>RS: updateProductRating(productId)
        RS->>EP: publish(ReviewCreatedEvent)
        
        RS-->>C: 200 OK {reviewResponse}
    end
            </div>
        </div>

        <!-- Rating Statistics -->
        <div class="section">
            <h2>üìä Rating Statistics (Shopee-like)</h2>
            <div class="mermaid">
flowchart LR
    subgraph Input["üì• Query"]
        Q[productId / orderId / imageAssetId]
    end

    subgraph Calculate["üßÆ Calculation"]
        C1[Count total reviews]
        C2[Calculate average rating]
        C3[Count per rating 1-5]
        C4[Count with images]
        C5[Count with comments]
    end

    subgraph Output["üì§ Statistics"]
        O1[totalReviews: 150]
        O2[averageRating: 4.7]
        O3[ratingDistribution: 5‚òÖ=100, 4‚òÖ=30, 3‚òÖ=15, 2‚òÖ=3, 1‚òÖ=2]
        O4[withImages: 45]
        O5[withComments: 120]
    end

    Q --> Calculate
    Calculate --> Output
            </div>

            <h3>Statistics Response Example</h3>
            <pre><code>{
    "totalReviews": 150,
    "averageRating": 4.7,
    "ratingDistribution": {
        "5": 100,
        "4": 30,
        "3": 15,
        "2": 3,
        "1": 2
    },
    "withImages": 45,
    "withComments": 120,
    "verifiedPurchases": 140
}</code></pre>

            <div class="info-box">
                <strong>‚≠ê Rating Display:</strong>
                <div class="star-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 4.7/5 (150 ƒë√°nh gi√°)</div>
            </div>
        </div>

        <!-- Shop Reply -->
        <div class="section">
            <h2>üí¨ Shop Reply Feature</h2>
            <div class="mermaid">
sequenceDiagram
    participant S as Staff
    participant RC as ReviewController
    participant RS as ReviewService
    participant RR as ReviewRepository

    S->>RC: POST /reviews/{id}/reply {replyContent}
    RC->>RS: reply(id, request, staffId)
    
    RS->>RR: findByIdAndIsDeletedFalse(id)
    RR-->>RS: ReviewEntity
    
    RS->>RS: Set shopReply = request.content
    RS->>RS: Set repliedBy = staffId
    RS->>RS: Set repliedAt = now()
    
    RS->>RR: save(review)
    RR-->>RS: updatedReview
    
    RS-->>S: 200 OK {reviewWithReply}
            </div>

            <h3>Review with Shop Reply Example</h3>
            <pre><code>{
    "id": 123,
    "rating": 5,
    "comment": "S·∫£n ph·∫©m r·∫•t ƒë·∫πp, may r·∫•t v·ª´a!",
    "userName": "Nguy·ªÖn VƒÉn A",
    "createdAt": "2024-01-15T10:30:00Z",
    "shopReply": {
        "content": "C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng! Ch√∫c qu√Ω kh√°ch s·ª≠ d·ª•ng vui v·∫ª.",
        "repliedBy": "Shop Manager",
        "repliedAt": "2024-01-16T09:00:00Z"
    }
}</code></pre>
        </div>

        <!-- Helpful Votes -->
        <div class="section">
            <h2>üëç Helpful Votes System</h2>
            <div class="mermaid">
erDiagram
    REVIEW ||--o{ REVIEW_HELPFUL_VOTE : has
    USER ||--o{ REVIEW_HELPFUL_VOTE : votes
    
    REVIEW {
        Long id PK
        Integer helpfulCount
    }
    
    REVIEW_HELPFUL_VOTE {
        Long id PK
        Long review_id FK
        Long user_id FK
        Timestamp created_at
    }
    
    USER {
        Long id PK
        String name
    }
            </div>

            <h3>Vote Logic</h3>
            <pre><code>// Vote helpful
1. Check if user already voted
2. If not, create ReviewHelpfulVote
3. Increment review.helpfulCount
4. Save review

// Unvote helpful
1. Find existing vote by user and review
2. Delete vote
3. Decrement review.helpfulCount
4. Save review</code></pre>
        </div>

        <!-- Moderation -->
        <div class="section">
            <h2>üîß Moderation System</h2>
            <table>
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>M√¥ t·∫£</th>
                        <th>New Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>approve</code></td>
                        <td>Duy·ªát review, cho hi·ªÉn th·ªã public</td>
                        <td>APPROVED</td>
                    </tr>
                    <tr>
                        <td><code>reject</code></td>
                        <td>T·ª´ ch·ªëi review (vi ph·∫°m ch√≠nh s√°ch)</td>
                        <td>REJECTED</td>
                    </tr>
                    <tr>
                        <td><code>hide</code></td>
                        <td>·∫®n t·∫°m th·ªùi ƒë·ªÉ xem x√©t</td>
                        <td>HIDDEN</td>
                    </tr>
                    <tr>
                        <td><code>unhide</code></td>
                        <td>Hi·ªán l·∫°i review ƒë√£ ·∫©n</td>
                        <td>APPROVED</td>
                    </tr>
                </tbody>
            </table>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Auto-Moderation (Future):</strong>
                <p>C√≥ th·ªÉ t√≠ch h·ª£p AI ƒë·ªÉ t·ª± ƒë·ªông ph√°t hi·ªán:</p>
                <ul>
                    <li>Spam reviews</li>
                    <li>Offensive language</li>
                    <li>Fake reviews</li>
                </ul>
            </div>
        </div>

        <!-- DTOs -->
        <div class="section">
            <h2>üì¶ Data Transfer Objects</h2>

            <h3>ReviewRequest</h3>
            <pre><code>{
    "rating": 5,
    "title": "S·∫£n ph·∫©m tuy·ªát v·ªùi!",
    "comment": "May r·∫•t ƒë·∫πp, v·∫£i t·ªët, giao h√†ng nhanh. R·∫•t h√†i l√≤ng!",
    "isAnonymous": false,
    "imageUrls": [
        "https://cdn.example.com/review-img-1.jpg",
        "https://cdn.example.com/review-img-2.jpg"
    ]
}</code></pre>

            <h3>ReviewResponse</h3>
            <pre><code>{
    "id": 123,
    "type": "PRODUCT",
    "productId": 456,
    "productName": "Vest Nam Cao C·∫•p",
    "userId": 789,
    "userName": "Nguy·ªÖn VƒÉn A",
    "userAvatar": "https://cdn.example.com/avatar.jpg",
    "rating": 5,
    "title": "S·∫£n ph·∫©m tuy·ªát v·ªùi!",
    "comment": "May r·∫•t ƒë·∫πp, v·∫£i t·ªët, giao h√†ng nhanh.",
    "isAnonymous": false,
    "isVerifiedPurchase": true,
    "status": "APPROVED",
    "helpfulCount": 15,
    "hasVotedHelpful": false,
    "images": [
        "https://cdn.example.com/review-img-1.jpg"
    ],
    "shopReply": {
        "content": "C·∫£m ∆°n qu√Ω kh√°ch!",
        "repliedBy": "Shop Manager",
        "repliedAt": "2024-01-16T09:00:00Z"
    },
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-01-15T10:30:00Z"
}</code></pre>

            <h3>ReviewFilterRequest</h3>
            <pre><code>{
    "type": "PRODUCT",
    "productId": 456,
    "rating": 5,
    "hasImages": true,
    "hasReply": false,
    "isVerifiedPurchase": true,
    "status": "APPROVED",
    "keyword": "t·ªët"
}</code></pre>
        </div>

        <!-- Dependencies -->
        <div class="section">
            <h2>üîó Dependencies</h2>
            <div class="mermaid">
flowchart LR
    subgraph ReviewModule["‚≠ê Review Module"]
        RS[ReviewService]
        RL[ReviewListener]
    end

    subgraph ProductModule["üì¶ Product Module"]
        PR[ProductRepository]
        IAR[ImageAssetRepository]
    end

    subgraph OrderModule["üìã Order Module"]
        OR[OrderRepository]
    end

    subgraph UserModule["üë§ User Module"]
        UR[UserRepository]
    end

    subgraph EventBus["üì° Spring Events"]
        EP[EventPublisher]
    end

    RS --> PR
    RS --> IAR
    RS --> OR
    RS --> UR
    RS --> EP
            </div>
        </div>

        <footer>
            <p>Tailor Shop - ReviewService Documentation</p>
            <p style="margin-top: 10px;">Generated for Backend Team Reference</p>
        </footer>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>

</html>
